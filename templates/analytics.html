<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analytics - Botifex</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Poppins", "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #ffffff;
            position: relative;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 123, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: particleFloat 20s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px;
        }

        .header {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 48px 40px;
            margin-bottom: 40px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(0, 191, 255, 0.15);
            border: 1px solid rgba(0, 191, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0.6;
        }

        .header h1 {
            color: #00bfff;
            font-size: 3rem;
            margin-bottom: 16px;
            text-align: center;
            text-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        .header p {
            color: rgba(255, 255, 255, 0.85);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 400;
            letter-spacing: 0.3px;
            max-width: 600px;
            margin: 0 auto;
        }

        .controls {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            gap: 24px;
            align-items: end;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 700;
            color: #00bfff;
            font-size: 0.95rem;
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .control-group select,
        .control-group input {
            padding: 14px 18px;
            border: 2px solid rgba(0, 191, 255, 0.3);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(22, 33, 62, 0.8);
            color: #ffffff;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.9);
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #00bfff 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 16px rgba(0, 191, 255, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 191, 255, 0.5);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px 28px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.4);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            color: #00bfff;
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(0, 191, 255, 0.6);
            letter-spacing: -1px;
            line-height: 1;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chart-container:hover::before {
            opacity: 1;
        }

        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.4);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #00bfff;
            margin-bottom: 24px;
            text-align: center;
            text-shadow: 0 0 15px rgba(0, 191, 255, 0.4);
            letter-spacing: 0.5px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #00bfff;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }

        .error {
            background: rgba(255, 71, 87, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(255, 71, 87, 0.5);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
        }

        .success {
            background: rgba(0, 255, 136, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.5);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }

        .navigation {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Market Analytics Dashboard</h1>
            <p>Comprehensive insights into your market data, trends, and performance metrics</p>
        </div>

        <div class="navigation">
            <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
            <button onclick="updateTrends()" class="btn">Update Trends</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="timeRange">Time Range</label>
                <select id="timeRange" onchange="loadAnalytics()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sourceFilter">Source</label>
                <select id="sourceFilter" onchange="loadAnalytics()">
                    <option value="">All Sources</option>
                    <option value="facebook">Facebook</option>
                    <option value="craigslist">Craigslist</option>
                    <option value="ksl">KSL</option>
                    <option value="ebay">eBay</option>
                    <option value="poshmark">Poshmark <span style="color: #667eea;">(Pro Only)</span></option>
                    <option value="mercari">Mercari <span style="color: #667eea;">(Pro Only)</span></option>
                </select>
            </div>
            <div class="control-group">
                <label for="keywordFilter">Keyword</label>
                <select id="keywordFilter" onchange="loadAnalytics()">
                    <option value="">All Keywords</option>
                </select>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="loadAnalytics()" class="btn">Refresh Data</button>
            </div>
        </div>

        <div id="statsContainer" class="stats-grid">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Selling Analytics Section -->
        <div id="sellingAnalyticsSection" style="margin: 40px 0; display: none;">
            <div style="background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(20px); border-radius: 20px; padding: 32px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(0, 191, 255, 0.15); border: 1px solid rgba(0, 191, 255, 0.2);">
                <h2 style="color: #00bfff; font-size: 2rem; margin-bottom: 24px; text-align: center; text-shadow: 0 0 20px rgba(0, 191, 255, 0.5);">üí∞ Your Selling Performance</h2>
                
                <!-- Selling Stats Cards -->
                <div id="sellingStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                    <!-- Stats cards will be loaded here -->
                </div>
                
                <!-- Selling Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 24px;">
                    <!-- Listings by Status -->
                    <div style="background: rgba(26, 26, 46, 0.8); border-radius: 16px; padding: 24px; border: 1px solid rgba(0, 191, 255, 0.2);">
                        <h3 style="color: #00bfff; margin-bottom: 16px; font-size: 1.2rem;">Listings by Status</h3>
                        <div id="sellingStatusChart" style="min-height: 200px;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Sales by Marketplace Pie Chart -->
                    <div style="background: rgba(26, 26, 46, 0.8); border-radius: 16px; padding: 24px; border: 1px solid rgba(0, 191, 255, 0.2);">
                        <h3 style="color: #00bfff; margin-bottom: 16px; font-size: 1.2rem;">Sales by Marketplace ü•ß</h3>
                        <div id="sellingMarketplaceChart" style="min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div style="background: rgba(26, 26, 46, 0.8); border-radius: 16px; padding: 24px; border: 1px solid rgba(0, 191, 255, 0.2);">
                        <h3 style="color: #00bfff; margin-bottom: 16px; font-size: 1.2rem;">Performance Metrics</h3>
                        <div id="sellingPerformanceMetrics" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Metrics will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Analytics Charts -->
        <div style="margin-top: 40px;">
            <h2 style="color: #00bfff; font-size: 2rem; margin-bottom: 24px; text-align: center; text-shadow: 0 0 20px rgba(0, 191, 255, 0.5);">üìä Market Insights</h2>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Price Trends Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Top Keywords</div>
                <div class="chart-wrapper">
                    <canvas id="keywordChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Source Comparison</div>
                <div class="chart-wrapper">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Price Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Hourly Activity</div>
                <div class="chart-wrapper">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Daily Listings</div>
                <div class="chart-wrapper">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentData = {};

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                showError('Chart library failed to load. Please refresh the page.');
                return;
            }
            console.log('Chart.js loaded successfully. Version:', Chart.version);
            
            loadAnalytics();
            loadKeywords();
            loadSellingAnalytics();
        });

        async function loadAnalytics() {
            const timeRange = document.getElementById('timeRange').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            const keywordFilter = document.getElementById('keywordFilter').value;
            
            try {
                showLoading();
                
                // Helper function to check and parse response
                const parseResponse = async (response) => {
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // Not JSON response, likely redirected to login
                        window.location.href = '/login';
                        throw new Error('Not authenticated - redirecting to login');
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                };
                
                // Build query parameters
                const keywordParam = keywordFilter ? `&keyword=${encodeURIComponent(keywordFilter)}` : '';
                
                // Load all analytics data in parallel
                const [marketInsights, priceAnalytics, sourceComparison, keywordAnalysis, hourlyActivity, priceDistribution] = await Promise.all([
                    fetch(`/api/analytics/market-insights?days=${timeRange}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse),
                    fetch(`/api/analytics/price-analytics?days=${timeRange}${sourceFilter ? `&source=${sourceFilter}` : ''}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse),
                    fetch(`/api/analytics/source-comparison?days=${timeRange}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse),
                    fetch(`/api/analytics/keyword-analysis?days=${timeRange}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse),
                    fetch(`/api/analytics/hourly-activity?days=${Math.min(timeRange, 7)}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse),
                    fetch(`/api/analytics/price-distribution?days=${timeRange}${keywordParam}`, {credentials: 'same-origin'}).then(parseResponse)
                ]);

                currentData = {
                    marketInsights,
                    priceAnalytics,
                    sourceComparison,
                    keywordAnalysis,
                    hourlyActivity,
                    priceDistribution
                };

                console.log('Analytics data loaded:', {
                    marketInsights: marketInsights ? 'yes' : 'no',
                    priceAnalytics: priceAnalytics?.analytics?.length || 0,
                    sourceComparison: sourceComparison?.comparison?.length || 0,
                    keywordAnalysis: keywordAnalysis?.analysis?.length || 0,
                    hourlyActivity: hourlyActivity?.activity?.length || 0,
                    priceDistribution: priceDistribution?.distribution?.length || 0
                });

                updateStats();
                updateCharts();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('Failed to load analytics data');
            }
        }

        async function loadKeywords() {
            try {
                const response = await fetch('/api/analytics/keyword-analysis?days=30', {credentials: 'same-origin'});
                const data = await response.json();
                
                const keywordSelect = document.getElementById('keywordFilter');
                keywordSelect.innerHTML = '<option value="">All Keywords</option>';
                
                if (data.analysis) {
                    data.analysis.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[0]; // keyword
                        option.textContent = `${item[0]} (${item[1]} listings)`;
                        keywordSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading keywords:', error);
            }
        }

        function updateStats() {
            if (!currentData || !currentData.marketInsights || !currentData.marketInsights.overall_stats) {
                console.error('No market insights data available');
                return;
            }
            
            const stats = currentData.marketInsights.overall_stats;

            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats[0] || 0}</div>
                    <div class="stat-label">Total Listings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${Math.round(stats[1] || 0).toLocaleString()}</div>
                    <div class="stat-label">Average Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${Math.round(stats[2] || 0).toLocaleString()}</div>
                    <div class="stat-label">Lowest Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${Math.round(stats[3] || 0).toLocaleString()}</div>
                    <div class="stat-label">Highest Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats[4] || 0}</div>
                    <div class="stat-label">Active Sources</div>
                </div>
            `;
        }

        function updateCharts() {
            updatePriceChart();
            updateKeywordChart();
            updateSourceChart();
            updateDistributionChart();
            updateActivityChart();
            updateDailyChart();
        }

        function updatePriceChart() {
            try {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                if (charts.priceChart) {
                    charts.priceChart.destroy();
                }

                if (!currentData || !currentData.priceAnalytics || !currentData.priceAnalytics.analytics) {
                    console.error('No price analytics data available');
                    return;
                }

                const data = currentData.priceAnalytics.analytics || [];
                console.log('Price analytics data:', data);
                
                if (data.length === 0) {
                    console.warn('Price analytics data is empty');
                    return;
                }
                
                const labels = data.map(item => new Date(item[0]).toLocaleDateString()).reverse();
                const avgPrices = data.map(item => item[2]).reverse();
                const counts = data.map(item => item[1]).reverse();

                charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Price',
                        data: avgPrices,
                        borderColor: '#00bfff',
                        backgroundColor: 'rgba(0, 191, 255, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Listings Count',
                        data: counts,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Average Price ($)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Listings Count'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
                });
                console.log('Price chart created successfully');
            } catch (error) {
                console.error('Error creating price chart:', error);
            }
        }

        function updateKeywordChart() {
            const ctx = document.getElementById('keywordChart').getContext('2d');
            
            if (charts.keywordChart) {
                charts.keywordChart.destroy();
            }

            if (!currentData || !currentData.keywordAnalysis || !currentData.keywordAnalysis.analysis) {
                console.error('No keyword analysis data available');
                return;
            }

            const data = currentData.keywordAnalysis.analysis || [];
            const labels = data.slice(0, 10).map(item => item[0]);
            const counts = data.slice(0, 10).map(item => item[1]);

            charts.keywordChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#00bfff', '#007bff', '#0099cc', '#0066cc',
                            '#004d99', '#003366', '#001a33', '#000d1a',
                            '#00ccff', '#0099ff'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSourceChart() {
            const ctx = document.getElementById('sourceChart').getContext('2d');
            
            if (charts.sourceChart) {
                charts.sourceChart.destroy();
            }

            if (!currentData || !currentData.sourceComparison || !currentData.sourceComparison.comparison) {
                console.error('No source comparison data available');
                return;
            }

            const data = currentData.sourceComparison.comparison || [];
            const labels = data.map(item => item[0]);
            const counts = data.map(item => item[1]);
            const avgPrices = data.map(item => item[2]);

            charts.sourceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Listings',
                        data: counts,
                        backgroundColor: 'rgba(0, 191, 255, 0.8)',
                        yAxisID: 'y'
                    }, {
                        label: 'Average Price',
                        data: avgPrices,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Listings Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Average Price ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (charts.distributionChart) {
                charts.distributionChart.destroy();
            }

            if (!currentData || !currentData.priceDistribution || !currentData.priceDistribution.distribution) {
                console.error('No price distribution data available');
                return;
            }

            const data = currentData.priceDistribution.distribution || [];
            const labels = data.map(item => item.range);
            const counts = data.map(item => item.count);

            charts.distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Listings',
                        data: counts,
                        backgroundColor: 'rgba(0, 191, 255, 0.8)',
                        borderColor: '#00bfff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Listings'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Price Range'
                            }
                        }
                    }
                }
            });
        }

        function updateActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (charts.activityChart) {
                charts.activityChart.destroy();
            }

            if (!currentData || !currentData.hourlyActivity || !currentData.hourlyActivity.activity) {
                console.error('No hourly activity data available');
                return;
            }

            const data = currentData.hourlyActivity.activity || [];
            const hours = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));
            const activityByHour = new Array(24).fill(0);
            
            data.forEach(item => {
                const hour = parseInt(item[0]);
                activityByHour[hour] += item[1];
            });

            charts.activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Listings Posted',
                        data: activityByHour,
                        borderColor: '#00bfff',
                        backgroundColor: 'rgba(0, 191, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Listings'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }

        function updateDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (charts.dailyChart) {
                charts.dailyChart.destroy();
            }

            if (!currentData || !currentData.priceAnalytics || !currentData.priceAnalytics.analytics) {
                console.error('No price analytics data available for daily chart');
                return;
            }

            const data = currentData.priceAnalytics.analytics || [];
            const labels = data.map(item => new Date(item[0]).toLocaleDateString()).reverse();
            const counts = data.map(item => item[1]).reverse();

            charts.dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Listings',
                        data: counts,
                        backgroundColor: 'rgba(0, 191, 255, 0.8)',
                        borderColor: '#00bfff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Listings'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        async function updateTrends() {
            try {
                const response = await fetch('/api/analytics/update-trends', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('Trends updated successfully!');
                    loadAnalytics();
                } else {
                    showError(result.error || 'Failed to update trends');
                }
            } catch (error) {
                console.error('Error updating trends:', error);
                showError('Failed to update trends');
            }
        }

        async function loadSellingAnalytics() {
            try {
                const response = await fetch('/api/seller-listings/stats', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    console.log('No selling data available');
                    return;
                }
                
                const data = await response.json();
                console.log('Selling analytics loaded:', data);
                
                if (data.stats && data.stats.total_listings > 0) {
                    document.getElementById('sellingAnalyticsSection').style.display = 'block';
                    renderSellingStats(data.stats);
                    renderSellingCharts(data.stats);
                }
            } catch (error) {
                console.error('Error loading selling analytics:', error);
            }
        }

        function renderSellingStats(stats) {
            const container = document.getElementById('sellingStatsGrid');
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_listings || 0}</div>
                    <div class="stat-label">Total Listings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.draft_count || 0}</div>
                    <div class="stat-label">Drafts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.posted_count || 0}</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.2) 0%, rgba(34, 139, 58, 0.2) 100%); border-color: rgba(40, 167, 69, 0.4);">
                    <div class="stat-value" style="color: #28a745;">${stats.sold_count || 0}</div>
                    <div class="stat-label">Sold Items üéâ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.2) 100%); border-color: rgba(255, 193, 7, 0.4);">
                    <div class="stat-value" style="color: #ffc107;">$${Math.round(stats.gross_revenue || 0).toLocaleString()}</div>
                    <div class="stat-label">Gross Revenue üí∞</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(34, 211, 137, 0.2) 0%, rgba(34, 167, 113, 0.2) 100%); border-color: rgba(34, 211, 137, 0.4);">
                    <div class="stat-value" style="color: ${(stats.true_profit || 0) >= 0 ? '#22d389' : '#ff6b6b'};">$${Math.round(stats.true_profit || 0).toLocaleString()}</div>
                    <div class="stat-label">True Profit üíé</div>
                </div>
            `;
        }

        function renderSellingCharts(stats) {
            // Render status chart
            const total = stats.total_listings || 1;
            const draftPct = ((stats.draft_count / total) * 100).toFixed(1);
            const activePct = ((stats.posted_count / total) * 100).toFixed(1);
            const soldPct = ((stats.sold_count / total) * 100).toFixed(1);
            
            document.getElementById('sellingStatusChart').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: rgba(255,255,255,0.9);">Drafts</span>
                            <span style="color: #007bff; font-weight: bold;">${stats.draft_count} (${draftPct}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #007bff, #00bfff); height: 100%; width: ${draftPct}%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: rgba(255,255,255,0.9);">Active</span>
                            <span style="color: #00bfff; font-weight: bold;">${stats.posted_count} (${activePct}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #00bfff, #00d4ff); height: 100%; width: ${activePct}%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: rgba(255,255,255,0.9);">Sold üéâ</span>
                            <span style="color: #28a745; font-weight: bold;">${stats.sold_count} (${soldPct}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #28a745, #34d058); height: 100%; width: ${soldPct}%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render marketplace pie chart
            renderSellingMarketplacePieChart(stats.marketplace_breakdown || {}, stats.sold_count || 0);
            
            // Render performance metrics
            const conversionRate = stats.posted_count > 0 
                ? ((stats.sold_count / stats.posted_count) * 100).toFixed(1) 
                : 0;
            const avgRevPerSale = stats.sold_count > 0 
                ? (stats.gross_revenue / stats.sold_count).toFixed(0) 
                : 0;
            
            const trueProfit = stats.true_profit || 0;
            const profitColor = trueProfit >= 0 ? '#22d389' : '#ff6b6b';
            const profitLabel = trueProfit >= 0 ? 'Profit' : 'Loss';
            
            const totalCosts = stats.total_costs || 0;
            const profitMargin = stats.gross_revenue > 0 && totalCosts > 0 ? ((trueProfit / stats.gross_revenue) * 100).toFixed(1) : 0;
            const costsTracked = totalCosts > 0;
            
            document.getElementById('sellingPerformanceMetrics').innerHTML = `
                <div style="padding: 12px; background: rgba(0,191,255,0.1); border-radius: 8px; border-left: 3px solid #00bfff;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Conversion Rate</div>
                    <div style="color: #00bfff; font-size: 1.8rem; font-weight: bold; margin-top: 4px;">${conversionRate}%</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 4px;">Posted ‚Üí Sold</div>
                </div>
                <div style="padding: 12px; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Gross Revenue</div>
                    <div style="color: #ffc107; font-size: 1.8rem; font-weight: bold; margin-top: 4px;">$${Math.round(stats.gross_revenue || 0).toLocaleString()}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 4px;">Total Received</div>
                </div>
                <div style="padding: 12px; background: rgba(40,167,69,0.1); border-radius: 8px; border-left: 3px solid ${costsTracked ? '#28a745' : 'rgba(255,193,7,0.6)'};">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Total Costs</div>
                    <div style="color: ${costsTracked ? '#28a745' : 'rgba(255,193,7,0.8)'}; font-size: 1.8rem; font-weight: bold; margin-top: 4px;">${costsTracked ? '$' : ''}${costsTracked ? Math.round(totalCosts).toLocaleString() : 'N/A'}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 4px;">${costsTracked ? 'What You Paid' : 'Add costs'}</div>
                </div>
                <div style="padding: 12px; background: rgba(34,211,137,0.1); border-radius: 8px; border-left: 3px solid ${costsTracked ? profitColor : 'rgba(255,193,7,0.6)'};">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">True ${costsTracked ? profitLabel : 'Profit'} üíé</div>
                    <div style="color: ${costsTracked ? profitColor : 'rgba(255,193,7,0.8)'}; font-size: 1.8rem; font-weight: bold; margin-top: 4px;">${costsTracked ? (trueProfit >= 0 ? '+' : '') + '$' + Math.round(trueProfit).toLocaleString() : 'N/A'}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 4px;">${costsTracked ? `Margin: ${profitMargin}%` : 'Track costs'}</div>
                </div>
            `;
        }

        function renderSellingMarketplacePieChart(marketplaceData, totalSold) {
            const container = document.getElementById('sellingMarketplaceChart');
            
            if (totalSold === 0 || Object.keys(marketplaceData).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 12px;">üìä</div>
                        <p>No sales data yet</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">Mark items as sold to see breakdown</p>
                    </div>
                `;
                return;
            }
            
            // Marketplace colors
            const colors = {
                'craigslist': '#6B46C1',
                'facebook': '#1877F2',
                'ksl': '#00A9E0',
                'ebay': '#E53238',
                'poshmark': '#667eea',
                'mercari': '#FF6B6B',
                'other': '#FFC107'
            };
            
            const labels = {
                'craigslist': 'Craigslist',
                'facebook': 'Facebook',
                'ksl': 'KSL',
                'ebay': 'eBay',
                'poshmark': 'Poshmark',
                'mercari': 'Mercari',
                'other': 'Other'
            };
            
            // Create pie chart segments
            let currentAngle = 0;
            const segments = [];
            
            Object.entries(marketplaceData).forEach(([marketplace, data]) => {
                const percentage = (data.count / totalSold) * 100;
                const angle = (data.count / totalSold) * 360;
                
                segments.push({
                    marketplace,
                    count: data.count,
                    percentage: percentage.toFixed(1),
                    revenue: data.revenue,
                    angle,
                    startAngle: currentAngle,
                    color: colors[marketplace] || colors['other'],
                    label: labels[marketplace] || marketplace
                });
                
                currentAngle += angle;
            });
            
            // Create visual pie chart using conic gradient
            const gradientStops = segments.map((seg) => {
                const start = seg.startAngle;
                const end = start + seg.angle;
                return `${seg.color} ${start}deg ${end}deg`;
            }).join(', ');
            
            container.innerHTML = `
                <div style="width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(${gradientStops}); margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);"></div>
                
                <div style="width: 100%; display: flex; flex-direction: column; gap: 8px;">
                    ${segments.map(seg => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid ${seg.color};">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${seg.color};"></div>
                                <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">${seg.label}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #00bfff; font-weight: bold;">${seg.count} (${seg.percentage}%)</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">$${Math.round(seg.revenue).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showLoading() {
            // Don't replace canvas elements - just show a loading indicator
            console.log('Loading analytics...');
        }

        function hideLoading() {
            console.log('Analytics loaded');
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
