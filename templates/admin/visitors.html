{% extends "admin/_base_admin.html" %}
{% block title %}Visitor Analytics{% endblock %}
{% block page_title %}Visitor Analytics{% endblock %}
{% block page_subtitle %}Track landing page visitors and conversions{% endblock %}

{% block extra_styles %}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: rgba(26, 26, 46, 0.8);
    border: 1px solid rgba(0, 191, 255, 0.2);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: rgba(0, 191, 255, 0.4);
    transform: translateY(-2px);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #00bfff 0%, #5dff9f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
}

.stat-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.chart-container {
    background: rgba(26, 26, 46, 0.6);
    border: 1px solid rgba(0, 191, 255, 0.2);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    height: 300px;
    position: relative;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-header h3 i {
    color: #00bfff;
}

.time-filter {
    display: flex;
    gap: 8px;
}

.time-btn {
    padding: 8px 16px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 191, 255, 0.3);
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
}

.time-btn:hover {
    background: rgba(0, 191, 255, 0.15);
    border-color: rgba(0, 191, 255, 0.5);
    color: #00bfff;
}

.time-btn.active {
    background: linear-gradient(135deg, #007bff 0%, #00bfff 100%);
    border-color: transparent;
    color: white;
}

.chart-area {
    height: 220px;
    position: relative;
}

.bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 100%;
    padding-bottom: 30px;
}

.bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 8px;
    max-width: 20px;
}

.bar {
    width: 100%;
    background: linear-gradient(180deg, #00bfff 0%, #007bff 100%);
    border-radius: 4px 4px 0 0;
    min-height: 2px;
    transition: all 0.3s ease;
    position: relative;
}

.bar:hover {
    background: linear-gradient(180deg, #5dff9f 0%, #00bfff 100%);
    transform: scaleX(1.2);
}

.bar:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 100;
    margin-bottom: 8px;
}

.bar-label {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 4px;
    transform: rotate(-45deg);
    white-space: nowrap;
}

.visitor-table {
    max-height: 600px;
    overflow-y: auto;
}

.ip-badge {
    font-family: 'Courier New', monospace;
    background: rgba(0, 0, 0, 0.3);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
}

.converted-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
}

.converted-badge.yes {
    background: linear-gradient(135deg, rgba(93, 255, 159, 0.2), rgba(40, 167, 69, 0.2));
    color: #5dff9f;
    border: 1px solid rgba(93, 255, 159, 0.3);
}

.converted-badge.no {
    background: rgba(108, 117, 125, 0.2);
    color: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(108, 117, 125, 0.3);
}

.duration-cell {
    font-weight: 600;
    color: #00bfff;
}

.user-agent-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
}

.page-path-cell {
    font-family: monospace;
    font-size: 12px;
    background: rgba(0, 0, 0, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
}

.legend {
    display: flex;
    gap: 24px;
    justify-content: center;
    margin-top: 16px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-color.visits {
    background: linear-gradient(180deg, #00bfff 0%, #007bff 100%);
}

.legend-color.conversions {
    background: linear-gradient(180deg, #5dff9f 0%, #28a745 100%);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255, 255, 255, 0.6);
}

.empty-state i {
    font-size: 48px;
    color: rgba(0, 191, 255, 0.3);
    margin-bottom: 16px;
}

.empty-state p {
    font-size: 16px;
}
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_visits | default(0) }}</div>
        <div class="stat-label">Total Visits</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.unique_visitors | default(0) }}</div>
        <div class="stat-label">Unique Visitors</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.conversions | default(0) }}</div>
        <div class="stat-label">Conversions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.conversion_rate | default(0) }}%</div>
        <div class="stat-label">Conversion Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% set avg_secs = stats.avg_duration_seconds | default(0) | int %}
            {% if avg_secs >= 60 %}
                {{ (avg_secs // 60) }}m {{ avg_secs % 60 }}s
            {% else %}
                {{ avg_secs }}s
            {% endif %}
        </div>
        <div class="stat-label">Avg. Duration</div>
    </div>
</div>

<!-- Chart Section -->
<div class="chart-container">
    <div class="chart-header">
        <h3><i class="fas fa-chart-bar"></i> Visits Over Time</h3>
        <div class="time-filter">
            <a href="{{ url_for('admin.visitor_analytics', hours=24) }}" class="time-btn {% if selected_hours == 24 %}active{% endif %}">24h</a>
            <a href="{{ url_for('admin.visitor_analytics', hours=48) }}" class="time-btn {% if selected_hours == 48 %}active{% endif %}">48h</a>
            <a href="{{ url_for('admin.visitor_analytics', hours=72) }}" class="time-btn {% if selected_hours == 72 %}active{% endif %}">72h</a>
            <a href="{{ url_for('admin.visitor_analytics', hours=168) }}" class="time-btn {% if selected_hours == 168 %}active{% endif %}">7d</a>
        </div>
    </div>
    <div class="chart-area">
        <div class="bar-chart" id="visitorChart"></div>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color visits"></div>
            <span>Visits</span>
        </div>
        <div class="legend-item">
            <div class="legend-color conversions"></div>
            <span>Conversions</span>
        </div>
    </div>
</div>

<!-- Visitor Sessions Table -->
<div class="section">
    <h2><i class="fas fa-users"></i> Recent Visitor Sessions</h2>
    
    {% if sessions %}
    <div class="visitor-table">
        <table>
            <thead>
                <tr>
                    <th>IP Address</th>
                    <th>Visit Time</th>
                    <th>Duration</th>
                    <th>Page</th>
                    <th>Converted</th>
                    <th>User Agent</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                <tr>
                    <td><span class="ip-badge">{{ session.ip_address }}</span></td>
                    <td>{{ session.started_at_display or 'N/A' }}</td>
                    <td class="duration-cell">{{ session.duration_display }}</td>
                    <td><span class="page-path-cell">{{ session.page_path }}</span></td>
                    <td>
                        {% if session.created_account %}
                        <span class="converted-badge yes">
                            <i class="fas fa-check-circle"></i>
                            {{ session.created_username or 'Yes' }}
                        </span>
                        {% else %}
                        <span class="converted-badge no">
                            <i class="fas fa-minus-circle"></i>
                            No
                        </span>
                        {% endif %}
                    </td>
                    <td class="user-agent-cell" title="{{ session.user_agent }}">{{ session.user_agent[:50] }}{% if session.user_agent|length > 50 %}...{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-chart-area"></i>
        <p>No visitor sessions recorded yet. Visits to the landing page will appear here.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const hourlyData = {{ hourly_data | safe }};
    const chartContainer = document.getElementById('visitorChart');
    
    if (!hourlyData || hourlyData.length === 0) {
        chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5);">No data for this time period</div>';
        return;
    }
    
    // Find max value for scaling
    const maxVisits = Math.max(...hourlyData.map(d => d.visit_count), 1);
    const chartHeight = 180; // pixels
    
    // Build bars
    let html = '';
    hourlyData.forEach(function(data, index) {
        const height = (data.visit_count / maxVisits) * chartHeight;
        const barHeight = Math.max(height, 2);
        
        // Parse hour for label
        const hourStr = data.hour;
        let label = '';
        try {
            const parts = hourStr.split(' ');
            if (parts.length >= 2) {
                const timePart = parts[1];
                const hour = parseInt(timePart.split(':')[0]);
                // Only show label every 6 hours or on day boundaries
                if (hour === 0) {
                    label = parts[0].split('-').slice(1).join('/'); // MM/DD
                } else if (hour % 6 === 0) {
                    label = hour + 'h';
                }
            }
        } catch(e) {}
        
        const tooltip = data.hour + ': ' + data.visit_count + ' visits, ' + data.conversions + ' conversions';
        
        html += '<div class="bar-group">';
        html += '<div class="bar" style="height: ' + barHeight + 'px;" data-tooltip="' + tooltip + '"></div>';
        if (label) {
            html += '<span class="bar-label">' + label + '</span>';
        }
        html += '</div>';
    });
    
    chartContainer.innerHTML = html;
})();
</script>
{% endblock %}

