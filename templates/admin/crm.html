{% extends "admin/_base_admin.html" %}

{% block title %}CRM - Customer Management{% endblock %}
{% block page_title %}CRM - Customer Relationship Management{% endblock %}
{% block page_subtitle %}Manage customer relationships, track engagement, and view customer insights{% endblock %}

{% block extra_styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: rgba(0, 191, 255, 0.1);
        border: 1px solid rgba(0, 191, 255, 0.3);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 800;
        color: #00bfff;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.6);
    }

    .filters {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-group label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 600;
    }

    .filter-group select,
    .filter-group input {
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(0, 191, 255, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #00bfff;
        box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
    }

    .contact-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(0, 191, 255, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .contact-card:hover {
        background: rgba(0, 191, 255, 0.08);
        border-color: rgba(0, 191, 255, 0.4);
        transform: translateX(4px);
    }

    .contact-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }

    .contact-name {
        font-size: 18px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 4px;
    }

    .contact-email {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
    }

    .contact-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .meta-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.5);
    }

    .meta-value {
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
    }

    .badge-plan {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-free {
        background: rgba(108, 117, 125, 0.3);
        color: rgba(255, 255, 255, 0.7);
    }

    .badge-standard {
        background: linear-gradient(135deg, #5dff9f 0%, #00d9ff 100%);
        color: #0a0a0f;
    }

    .badge-pro {
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        color: #0a0a0f;
    }

    .view-link {
        color: #00bfff;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .view-link:hover {
        color: #5dddff;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Contacts</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.free }}</div>
        <div class="stat-label">Free Plan</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.standard }}</div>
        <div class="stat-label">Standard Plan</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.pro }}</div>
        <div class="stat-label">Pro Plan</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.active_searches }}</div>
        <div class="stat-label">Total Searches</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_alerts }}</div>
        <div class="stat-label">Total Alerts</div>
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-address-book"></i> Customer Contacts ({{ contacts|length }})</h2>
    
    <div class="filters">
        <div class="filter-group" style="flex: 1; min-width: 300px;">
            <label>Search</label>
            <input type="text" id="searchInput" placeholder="Search by email, username, or name..." 
                   value="{{ search_query }}" 
                   onkeyup="handleSearch()">
        </div>
        <div class="filter-group">
            <label>Plan Tier</label>
            <select id="planFilter" onchange="handleFilter()">
                <option value="">All Plans</option>
                <option value="free" {% if plan_filter == 'free' %}selected{% endif %}>Free</option>
                <option value="standard" {% if plan_filter == 'standard' %}selected{% endif %}>Standard</option>
                <option value="pro" {% if plan_filter == 'pro' %}selected{% endif %}>Pro</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select id="sortBy" onchange="handleFilter()">
                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created Date</option>
                <option value="email" {% if sort_by == 'email' %}selected{% endif %}>Email</option>
                <option value="plan_tier" {% if sort_by == 'plan_tier' %}selected{% endif %}>Plan Tier</option>
                <option value="searches" {% if sort_by == 'searches' %}selected{% endif %}>Searches</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Order</label>
            <select id="sortOrder" onchange="handleFilter()">
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
            </select>
        </div>
    </div>

    {% if contacts %}
        {% for contact in contacts %}
        <div class="contact-card">
            <div class="contact-header">
                <div>
                    <div class="contact-name">
                        {% if contact.first_name or contact.last_name %}
                            {{ contact.first_name or '' }} {{ contact.last_name or '' }}
                        {% else %}
                            {{ contact.username or contact.email }}
                        {% endif %}
                    </div>
                    <div class="contact-email">{{ contact.email }}</div>
                </div>
                <div>
                    {% if contact.plan_tier %}
                        <span class="badge-plan badge-{{ contact.plan_tier }}">{{ contact.plan_tier|title }}</span>
                    {% else %}
                        <span class="badge-plan badge-free">Free</span>
                    {% endif %}
                </div>
            </div>
            <div class="contact-meta">
                <div class="meta-item">
                    <div class="meta-label">Username</div>
                    <div class="meta-value">{{ contact.username or 'N/A' }}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Phone</div>
                    <div class="meta-value">{{ contact.phone or 'N/A' }}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Searches Made</div>
                    <div class="meta-value">{{ contact.searches_made or 0 }}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Alerts Created</div>
                    <div class="meta-value">{{ contact.alerts_created or 0 }}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Saved Listings</div>
                    <div class="meta-value">{{ contact.saved_listings or 0 }}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Signup Date</div>
                    <div class="meta-value">{{ contact.signup_date or contact.created_at or 'N/A' }}</div>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <a href="{{ url_for('admin.crm_contact_detail', email=contact.email) }}" class="view-link">
                    <i class="fas fa-eye"></i> View Full Details
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <p>No contacts found matching your criteria.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let searchTimeout;
    
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            handleFilter();
        }, 500);
    }
    
    function handleFilter() {
        const search = document.getElementById('searchInput').value;
        const plan = document.getElementById('planFilter').value;
        const sort = document.getElementById('sortBy').value;
        const order = document.getElementById('sortOrder').value;
        
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (plan) params.append('plan', plan);
        if (sort) params.append('sort', sort);
        if (order) params.append('order', order);
        
        window.location.href = '{{ url_for("admin.crm") }}?' + params.toString();
    }
</script>
{% endblock %}

