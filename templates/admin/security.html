{% extends "admin/_base_admin.html" %}

{% block title %}Security Monitoring{% endblock %}
{% block page_title %}Security Monitoring{% endblock %}
{% block page_subtitle %}Monitor security events and blocked IPs{% endblock %}

{% block extra_styles %}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: rgba(26, 26, 46, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 191, 255, 0.2);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
}

.stat-card.danger::before {
    background: linear-gradient(90deg, transparent, #ff6b6b, transparent);
}

.stat-card.warning::before {
    background: linear-gradient(90deg, transparent, #ffd93d, transparent);
}

.stat-card.info::before {
    background: linear-gradient(90deg, transparent, #00bfff, transparent);
}

.stat-card.success::before {
    background: linear-gradient(90deg, transparent, #5dff9f, transparent);
}

.stat-card:hover {
    transform: translateY(-4px);
    border-color: rgba(0, 191, 255, 0.4);
    box-shadow: 0 8px 24px rgba(0, 191, 255, 0.2);
}

.stat-card h3 {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    font-weight: 600;
}

.stat-card .value {
    font-size: 36px;
    font-weight: 800;
    background: linear-gradient(135deg, #00bfff 0%, #007bff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-card .icon {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 32px;
    color: rgba(0, 191, 255, 0.2);
}

.refresh-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #00bfff 0%, #007bff 100%);
    color: white;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    margin-bottom: 24px;
}

.refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 191, 255, 0.4);
}

.ip-badge {
    display: inline-block;
    padding: 8px 14px;
    background: rgba(255, 107, 107, 0.2);
    border: 1px solid rgba(255, 107, 107, 0.4);
    border-radius: 10px;
    margin: 4px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #ff6b9d;
}

.event-row {
    background: rgba(255, 255, 255, 0.03);
    transition: all 0.2s ease;
}

.event-row.danger {
    border-left: 3px solid #ff6b6b;
}

.event-row.warning {
    border-left: 3px solid #ffd93d;
}

.event-row:hover {
    background: rgba(0, 191, 255, 0.08);
}

code {
    background: rgba(0, 0, 0, 0.3);
    padding: 4px 8px;
    border-radius: 6px;
    color: #00bfff;
    font-size: 12px;
}
{% endblock %}

{% block content %}
<button class="refresh-btn" onclick="refreshData()">
    <i class="fas fa-sync-alt"></i>
    Refresh Data
</button>

<div class="stats-grid">
    <div class="stat-card danger">
        <i class="fas fa-ban icon"></i>
        <h3>Blocked IPs</h3>
        <div class="value">{{ stats.blocked_ips }}</div>
    </div>
    <div class="stat-card warning">
        <i class="fas fa-exclamation-triangle icon"></i>
        <h3>Suspicious IPs</h3>
        <div class="value">{{ stats.suspicious_ips }}</div>
    </div>
    <div class="stat-card info">
        <i class="fas fa-eye icon"></i>
        <h3>Tracked IPs</h3>
        <div class="value">{{ stats.tracked_ips }}</div>
    </div>
    <div class="stat-card success">
        <i class="fas fa-list icon"></i>
        <h3>Recent Events</h3>
        <div class="value">{{ events|length }}</div>
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-shield-alt"></i> Recent Security Events</h2>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>IP Address</th>
                <th>Path</th>
                <th>User Agent</th>
                <th>Reason</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr class="event-row {% if 'blocked' in event.reason.lower() %}danger{% elif 'suspicious' in event.reason.lower() %}warning{% endif %}">
                <td>
                    <small>{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') if event.timestamp else 'N/A' }}</small>
                </td>
                <td>
                    <code>{{ event.ip_address }}</code>
                    {% if event.ip_address in stats.blocked_ips_list %}
                        <span class="badge badge-admin">Blocked</span>
                    {% elif event.ip_address in stats.suspicious_ips_list %}
                        <span class="badge badge-inactive">Suspicious</span>
                    {% endif %}
                </td>
                <td>
                    <code>{{ event.path }}</code>
                </td>
                <td>
                    <small>{{ event.user_agent[:50] }}{% if event.user_agent|length > 50 %}...{% endif %}</small>
                </td>
                <td>
                    <span class="badge badge-admin">{{ event.reason }}</span>
                </td>
                <td>
                    <a href="javascript:void(0)" onclick="viewEventDetails('{{ event.ip_address }}')" style="color: #00bfff;">
                        <i class="fas fa-eye"></i> View
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if stats.blocked_ips_list %}
<div class="section">
    <h2><i class="fas fa-ban"></i> Currently Blocked IPs ({{ stats.blocked_ips_list|length }})</h2>
    <div style="margin-top: 16px;">
        {% for ip in stats.blocked_ips_list %}
        <span class="ip-badge"><i class="fas fa-ban"></i> {{ ip }}</span>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if stats.suspicious_ips_list %}
<div class="section">
    <h2><i class="fas fa-exclamation-triangle"></i> Suspicious IPs ({{ stats.suspicious_ips_list|length }})</h2>
    <div style="margin-top: 16px;">
        {% for ip, count in stats.suspicious_ips_list.items() %}
        <span class="ip-badge" style="background: rgba(255, 211, 61, 0.2); border-color: rgba(255, 211, 61, 0.4); color: #ffd93d;">
            <i class="fas fa-exclamation-triangle"></i> {{ ip }} ({{ count }})
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function refreshData() {
    location.reload();
}

function viewEventDetails(ipAddress) {
    alert(`Viewing details for IP: ${ipAddress}`);
    // Future: Show modal with detailed information
}

// Auto-refresh every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
