<!DOCTYPE html>
<html>
<head>
    <title>Botifex Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ====================== */
        /* GENERAL RESET & PAGE */
        /* ====================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Poppins", "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            color: #ffffff;
            display: flex;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 123, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: particleFloat 20s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        a { text-decoration: none; color: inherit; }

        /* ====================== */
        /* SIDEBAR */
        /* ====================== */
        .sidebar {
            width: 260px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 123, 255, 0.2);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 0 0 30px rgba(0, 123, 255, 0.1);
            position: relative;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 191, 255, 0.3) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 2px;
        }

        .logo-container {
            margin-bottom: 32px;
            padding-bottom: 16px;
            position: relative;
            text-align: center;
        }

        .logo-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #00bfff, transparent);
            border-radius: 1px;
        }

        .logo {
            max-width: 120px;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(0, 191, 255, 0.5));
            transition: all 0.3s ease;
        }

        .logo:hover {
            filter: drop-shadow(0 0 15px rgba(0, 191, 255, 0.8));
            transform: scale(1.05);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.85);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .sidebar a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 191, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .sidebar a:hover::before {
            left: 100%;
        }

        .sidebar a:hover {
            background: rgba(0, 123, 255, 0.1);
            border-color: rgba(0, 191, 255, 0.3);
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(0, 191, 255, 0.15);
            color: #ffffff;
        }

        .sidebar a i {
            margin-right: 14px;
            color: #00bfff;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* ====================== */
        /* MAIN CONTENT */
        /* ====================== */
        .main {
            flex-grow: 1;
            padding: 40px 48px;
            background: rgba(10, 10, 15, 0.3);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 191, 255, 0.3) transparent;
        }

        .main::-webkit-scrollbar {
            width: 6px;
        }

        .main::-webkit-scrollbar-track {
            background: transparent;
        }

        .main::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 3px;
        }

        h2 {
            margin-bottom: 24px;
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        h2 i {
            color: #00bfff;
            margin-right: 12px;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
            font-size: 24px;
        }

        /* ====================== */
        /* CARDS */
        /* ====================== */
        .card {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* FORM STYLING */
        /* ====================== */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0 20px 0;
            border-radius: 12px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.8);
            color: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.9);
        }

        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input[type="submit"], button {
            background: linear-gradient(135deg, #007bff 0%, #00bfff 100%);
            color: #ffffff;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 191, 255, 0.3);
        }

        input[type="submit"]::before, button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        input[type="submit"]:hover::before, button:hover::before {
            left: 100%;
        }

        input[type="submit"]:hover, button:hover {
            background: linear-gradient(135deg, #00bfff 0%, #007bff 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 191, 255, 0.5);
        }

        input[type="submit"]:active, button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* TABLE STYLING */
        /* ====================== */
        table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        th, td {
            padding: 18px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 191, 255, 0.1);
        }

        th {
            background: rgba(0, 123, 255, 0.2);
            color: #00bfff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background: rgba(22, 33, 62, 0.3);
        }

        tr:hover {
            background: rgba(0, 191, 255, 0.1);
            transform: scale(1.002);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 191, 255, 0.1);
        }

        tr a {
            color: #00bfff;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        tr a:hover {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
        }

        /* ====================== */
        /* STATUS STYLING */
        /* ====================== */
        .status-running {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-stopped {
            color: #ff4757;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        /* ====================== */
        /* IMAGE STYLING */
        /* ====================== */
        img {
            border-radius: 8px;
            max-height: 80px;
            border: 2px solid rgba(0, 191, 255, 0.3);
            transition: all 0.3s ease;
        }

        img:hover {
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            transform: scale(1.05);
        }

        /* ====================== */
        /* RESPONSIVE TABLE SCROLL */
        /* ====================== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* ====================== */
        /* NOTIFICATION STYLING */
        /* ====================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .notification.error {
            background: rgba(255, 71, 87, 0.9);
            border: 1px solid rgba(255, 71, 87, 0.5);
        }

        .notification.success {
            background: rgba(0, 255, 136, 0.9);
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .notification.info {
            background: rgba(0, 191, 255, 0.9);
            border: 1px solid rgba(0, 191, 255, 0.5);
        }

        /* Favorite Button Styles */
        .favorite-btn {
            background: transparent;
            border: 1px solid rgba(0, 191, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .favorite-btn:hover {
            background: rgba(0, 191, 255, 0.1);
            border-color: rgba(0, 191, 255, 0.6);
            color: #00bfff;
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ffd700;
            border-color: #ffd700;
        }

        .favorite-btn.favorited i {
            font-weight: 900;
        }

        /* Saved Searches Section */
        .saved-searches-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(20, 20, 35, 0.95);
            border-radius: 12px;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .saved-search-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 123, 255, 0.05);
            border: 1px solid rgba(0, 123, 255, 0.2);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .saved-search-item:hover {
            background: rgba(0, 123, 255, 0.1);
            border-color: rgba(0, 123, 255, 0.4);
            transform: translateX(4px);
        }

        .search-info {
            flex: 1;
        }

        .search-actions {
            display: flex;
            gap: 10px;
        }

        .search-actions button {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-actions button:hover {
            background: rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.6);
        }

        .search-actions button.delete:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: rgba(255, 68, 68, 0.6);
            color: #ff4444;
        }
    </style>
</head>
<body>
    <!-- ====================== -->
    <!-- SIDEBAR -->
    <!-- ====================== -->
    <div class="sidebar">
        <div class="logo-container">
            <a href="{{ url_for('dashboard') }}">
                <img src="{{ url_for('static', filename='images/botifex-logo.svg') }}" alt="Botifex" class="logo">
            </a>
        </div>
        <a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
        <a href="{{ url_for('profile_page') }}"><i class="fas fa-user"></i> Profile</a>
        <a href="{{ url_for('favorites_page') }}"><i class="fas fa-star"></i> Favorites</a>
        <a href="{{ url_for('alerts_page') }}"><i class="fas fa-bell"></i> Price Alerts</a>
        <a href="/analytics"><i class="fas fa-chart-line"></i> Analytics</a>
        <a href="/selling"><i class="fas fa-dollar-sign"></i> Sell Items</a>
        <a href="#bot-control"><i class="fas fa-play-circle"></i> Bot Control</a>
        <a href="#recent-listings"><i class="fas fa-list"></i> Recent Listings</a>
        <a href="/api-docs" target="_blank"><i class="fas fa-book"></i> API Docs</a>
        {% if current_user.is_authenticated %}
            {% set user_data = None %}
            {% for u in [current_user.id] %}
                <!-- Check if user is admin -->
            {% endfor %}
        {% endif %}
        <a href="/admin" id="admin-link" style="display: none;"><i class="fas fa-user-shield"></i> Admin Panel</a>
        <a href="/subscription"><i class="fas fa-crown"></i> Subscription <span style="background: #667eea; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;">{{ user_tier|upper }}</span></a>
        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- ====================== -->
    <!-- MAIN CONTENT -->
    <!-- ====================== -->
    <div class="main">
        <!-- SETTINGS CARD -->
        <!-- SETTINGS CARD (merged into main page) -->
<div id="settings" class="card">
    <h2><i class="fas fa-cog"></i> Search Settings</h2>
    <form action="/update_settings" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        Location (City, State):<br>
        <input type="text" name="location" value="{{ settings.get('location','Boise, ID') }}"><br>
        
        Radius (miles):<br>
        <input type="number" name="radius" value="{{ settings.get('radius',50) }}"><br>

        Keywords (comma separated):<br>
        <input type="text" name="keywords" value="{% if settings.get('keywords') is string %}{{ settings.get('keywords') }}{% else %}{{ settings.get('keywords', 'Firebird,Camaro,Corvette') }}{% endif %}"><br>

        Min Price:<br>
        <input type="number" name="min_price" value="{{ settings.get('min_price',1000) }}"><br>

        Max Price:<br>
        <input type="number" name="max_price" value="{{ settings.get('max_price',30000) }}"><br>

        Check Interval (seconds):<br>
        <input type="number" name="interval" value="{{ settings.get('interval',60) }}"><br>

        <input type="submit" value="Update Settings">
        <button type="button" onclick="saveCurrentSearch()" style="margin-left: 10px; background: linear-gradient(135deg, #28a745, #20c997); border: none; padding: 10px 20px; border-radius: 8px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
            <i class="fas fa-save"></i> Save as Search
        </button>
    </form>

    <!-- Saved Searches Section -->
    <div class="saved-searches-section">
        <h3 style="margin-bottom: 15px; color: #00bfff;">
            <i class="fas fa-bookmark"></i> Saved Searches
        </h3>
        <div id="savedSearchesList">
            <p style="text-align: center; color: rgba(255,255,255,0.5);">Loading...</p>
        </div>
    </div>
</div>
        <!-- BOT CONTROL CARD -->
        <div id="bot-control" class="card">
            <h2><i class="fas fa-play-circle"></i> Bot Control</h2>
            
            <!-- Start/Stop All Buttons -->
            <div style="margin-bottom: 20px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="/start-all" title="Start all monitors available in your {{ user_tier|capitalize }} plan">
                    <button style="background: linear-gradient(135deg, #28a745, #20c997); font-size: 16px; padding: 14px 28px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-rocket"></i> Start All Monitors
                    </button>
                </a>
                <a href="/stop-all" title="Stop all monitors available in your {{ user_tier|capitalize }} plan">
                    <button style="background: linear-gradient(135deg, #dc3545, #c82333); font-size: 16px; padding: 14px 28px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-stop-circle"></i> Stop All Monitors
                    </button>
                </a>
            </div>
            <p style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: -10px; margin-bottom: 15px;">
                <i class="fas fa-info-circle"></i> Start/Stop All will only affect platforms available in your <strong>{{ user_tier|capitalize }}</strong> plan
            </p>
            
            <div class="table-container">
            <table>
                <tr>
                    <th>Site</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                {% for site, stat in status.items() %}
                <tr>
                    <td>
                        {{ site.capitalize() }}
                        {% if (site == 'poshmark' or site == 'mercari') and user_tier != 'pro' %}
                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 5px; color: white;">
                                <i class="fas fa-crown"></i> PRO
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat %}
                            <span class="status-running">Running</span>
                        {% else %}
                            <span class="status-stopped">Stopped</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if (site == 'poshmark' or site == 'mercari') and user_tier != 'pro' %}
                            <a href="/subscription/plans"><button style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white;">
                                <i class="fas fa-lock"></i> Upgrade to Pro
                            </button></a>
                        {% elif not stat %}
                            <a href="/start/{{ site }}"><button>Start</button></a>
                        {% else %}
                            <a href="/stop/{{ site }}"><button>Stop</button></a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            </div>
        </div>

        <!-- RECENT LISTINGS CARD -->
        <div id="recent-listings" class="card table-container">
            <h2><i class="fas fa-list"></i> Recent Listings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Source</th>
                        <th>Link</th>
                        <th>Image</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="listings_table">
                    {% for l in listings %}
                    <tr data-listing-id="{{ l[0] }}">
                        <td>{{ l[1] }}</td>
                        <td>{{ l[2] }}</td>
                        <td>{{ l[5] }}</td>
                        <td><a href="{{ l[3] }}" target="_blank">Link</a></td>
                        <td>{% if l[4] %}<img src="{{ l[4] }}" width="80">{% endif %}</td>
                        <td>{{ l[6] }}</td>
                        <td>
                            <button class="favorite-btn" 
                                    data-id="{{ l[0] }}" 
                                    data-title="{{ l[1] }}" 
                                    data-price="{{ l[2] }}" 
                                    data-link="{{ l[3] }}" 
                                    data-image="{{ l[4] or '' }}" 
                                    data-source="{{ l[5] }}" 
                                    title="Add to Favorites">
                                <i class="far fa-star"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ====================== -->
    <!-- LIVE UPDATES SCRIPT -->
    <!-- ====================== -->
    <script>
        // Check if user is admin and show admin link
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                // Admin link visibility will be handled by Flask backend
                // For now, check if user has admin role via user info
            })
            .catch(err => console.log('Could not check admin status'));

        // Keep track of existing listings to detect new ones
        let knownListings = new Set();
        const listingsTable = document.getElementById("listings_table");
        if (listingsTable) {
            listingsTable.querySelectorAll("tr").forEach(tr => {
                const linkElement = tr.querySelector("a");
                if (linkElement && linkElement.href) {
                    knownListings.add(linkElement.href);
                }
            });
        }

        // Store interval IDs for cleanup
        let statusInterval = null;
        let listingsInterval = null;

        // Function to update bot status with health information
        function updateStatus() {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            // Fetch both status and health in parallel
            Promise.all([
                fetch("/api/status", { signal: controller.signal }).then(res => res.ok ? res.json() : {}),
                fetch("/api/scraper-health", { signal: controller.signal }).then(res => res.ok ? res.json() : {})
            ])
                .then(([statusData, healthData]) => {
                    clearTimeout(timeoutId);
                    
                    const botControlTable = document.querySelector("#bot-control table");
                    if (!botControlTable) {
                        console.warn("Bot control table not found");
                        return;
                    }
                    
                    for (const [site, running] of Object.entries(statusData)) {
                        if (!site) continue;
                        
                        // Get health information for this site
                        const health = healthData[site] || {};
                        const healthStatus = health.status || 'unknown';
                        const lastError = health.last_error;
                        
                        // Fix: Use proper DOM traversal with null checks
                        const rows = botControlTable.querySelectorAll("tr");
                        let targetRow = null;
                        
                        for (const row of rows) {
                            const firstCell = row.querySelector("td:first-child");
                            if (firstCell && firstCell.textContent) {
                                // Extract just the site name, ignoring badges
                                const cellText = firstCell.textContent.trim().toLowerCase().split(/\s+/)[0];
                                const siteName = site.toLowerCase();
                                if (cellText === siteName) {
                                    targetRow = row;
                                    break;
                                }
                            }
                        }
                        
                        if (!targetRow) continue;
                        
                        const cells = targetRow.querySelectorAll("td");
                        if (cells && cells.length >= 3) {
                            const statusCell = cells[1];
                            const actionCell = cells[2];
                            
                            if (statusCell && actionCell) {
                                // Build status HTML with health indicator
                                let statusHTML = '';
                                let statusTitle = '';
                                
                                if (running) {
                                    if (healthStatus === 'healthy') {
                                        statusHTML = '<span class="status-running" title="Running normally">✓ Running</span>';
                                    } else if (healthStatus === 'degraded') {
                                        statusHTML = '<span class="status-running" style="color: #ffaa00;" title="Running with some errors">⚠ Running</span>';
                                        statusTitle = lastError ? `Last error: ${lastError.message}` : '';
                                    } else if (healthStatus === 'unhealthy') {
                                        statusHTML = '<span class="status-running" style="color: #ff6600;" title="Running with many errors">⚠ Unhealthy</span>';
                                        statusTitle = lastError ? `Last error: ${lastError.message}` : '';
                                    } else {
                                        statusHTML = '<span class="status-running">Running</span>';
                                    }
                                } else {
                                    statusHTML = '<span class="status-stopped">Stopped</span>';
                                    if (lastError) {
                                        statusTitle = `Last error: ${lastError.message}`;
                                    }
                                }
                                
                                statusCell.innerHTML = statusHTML;
                                if (statusTitle) {
                                    statusCell.title = statusTitle;
                                }
                                
                                actionCell.innerHTML = running
                                    ? `<a href="/stop/${escapeHtml(site)}"><button type="button">Stop</button></a>`
                                    : `<a href="/start/${escapeHtml(site)}"><button type="button">Start</button></a>`;
                            }
                        }
                    }
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Status update timeout");
                    } else {
                        console.error("Status update error:", err);
                    }
                    // Don't show notification for every failed update to avoid spam
                });
        }

        // Function to update listings
        function updateListings() {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch("/api/listings", { signal: controller.signal })
                .then(res => {
                    clearTimeout(timeoutId);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || !Array.isArray(data.listings)) {
                        throw new Error('Invalid listings data');
                    }
                    
                    const tbody = document.getElementById("listings_table");
                    if (!tbody) {
                        console.warn('Listings table not found');
                        return;
                    }
                    
                    tbody.innerHTML = ""; // clear current rows
                    
                    data.listings.forEach(l => {
                        if (!Array.isArray(l) || l.length < 7) {
                            console.warn('Invalid listing data:', l);
                            return;
                        }
                        
                        const listingId = l[0] || '';
                        const title = l[1] || '';
                        const price = l[2] || '';
                        const link = l[3] || '';
                        const imageUrl = l[4] || '';
                        const source = l[5] || '';
                        const createdAt = l[6] || '';
                        
                        const tr = document.createElement("tr");
                        tr.setAttribute('data-listing-id', listingId);
                        
                        // Create cells with proper escaping
                        const titleCell = document.createElement("td");
                        titleCell.textContent = title;
                        
                        const priceCell = document.createElement("td");
                        priceCell.textContent = price;
                        
                        const sourceCell = document.createElement("td");
                        sourceCell.textContent = source;
                        
                        const linkCell = document.createElement("td");
                        if (link) {
                            const linkAnchor = document.createElement("a");
                            linkAnchor.href = link;
                            linkAnchor.textContent = "Link";
                            linkAnchor.target = "_blank";
                            linkAnchor.rel = "noopener noreferrer";
                            linkCell.appendChild(linkAnchor);
                        }
                        
                        const imageCell = document.createElement("td");
                        if (imageUrl) {
                            const img = document.createElement("img");
                            img.src = imageUrl;
                            img.width = 80;
                            img.alt = "Listing image";
                            img.onerror = function() { this.style.display = 'none'; };
                            imageCell.appendChild(img);
                        }
                        
                        const dateCell = document.createElement("td");
                        dateCell.textContent = createdAt;
                        
                        // Actions cell with favorite button
                        const actionsCell = document.createElement("td");
                        const favoriteBtn = document.createElement("button");
                        favoriteBtn.className = "favorite-btn";
                        favoriteBtn.title = "Add to Favorites";
                        favoriteBtn.onclick = function() {
                            toggleFavorite(listingId, title, price, link, imageUrl, source);
                        };
                        const icon = document.createElement("i");
                        icon.className = "far fa-star";
                        favoriteBtn.appendChild(icon);
                        actionsCell.appendChild(favoriteBtn);
                        
                        // Append all cells
                        tr.appendChild(titleCell);
                        tr.appendChild(priceCell);
                        tr.appendChild(sourceCell);
                        tr.appendChild(linkCell);
                        tr.appendChild(imageCell);
                        tr.appendChild(dateCell);
                        tr.appendChild(actionsCell);
                        
                        // Highlight new listings
                        if (link && !knownListings.has(link)) {
                            tr.style.backgroundColor = "#00ff9944";
                            setTimeout(() => {
                                if (tr.style) {
                                    tr.style.backgroundColor = "";
                                }
                            }, 3000);
                            knownListings.add(link);
                        }
                        
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Listings update timeout");
                    } else {
                        console.error("Listings update error:", err);
                    }
                    // Don't show notification for every failed update
                });
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Favorite functionality
        async function toggleFavorite(listingId, title, price, link, imageUrl, source) {
            const button = event.target.closest('.favorite-btn');
            
            // If called from data attributes, read them
            if (!listingId && button) {
                listingId = button.dataset.id;
                title = button.dataset.title;
                price = button.dataset.price;
                link = button.dataset.link;
                imageUrl = button.dataset.image;
                source = button.dataset.source;
            }
            
            const isFavorited = button.classList.contains('favorited');

            try {
                if (isFavorited) {
                    // Remove from favorites
                    const response = await fetch(`/api/favorites/${listingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        button.classList.remove('favorited');
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        showNotification('Removed from favorites', 'info');
                    } else {
                        throw new Error('Failed to remove favorite');
                    }
                } else {
                    // Add to favorites
                    const response = await fetch(`/api/favorites/${listingId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            notes: ''
                        })
                    });

                    if (response.ok) {
                        button.classList.add('favorited');
                        button.querySelector('i').classList.remove('far');
                        button.querySelector('i').classList.add('fas');
                        showNotification('Added to favorites!', 'success');
                    } else {
                        throw new Error('Failed to add favorite');
                    }
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                showNotification('Error updating favorite', 'error');
            }
        }

        // Load saved searches
        async function loadSavedSearches() {
            try {
                const response = await fetch('/api/saved-searches');
                const data = await response.json();
                
                const container = document.getElementById('savedSearchesList');
                if (!container) return;

                if (data.searches && data.searches.length > 0) {
                    container.innerHTML = data.searches.map(search => `
                        <div class="saved-search-item">
                            <div class="search-info">
                                <strong>${escapeHtml(search.name)}</strong><br>
                                <small>
                                    ${search.keywords ? `Keywords: ${escapeHtml(search.keywords)}` : ''} 
                                    ${search.min_price ? `| Min: $${search.min_price}` : ''} 
                                    ${search.max_price ? `| Max: $${search.max_price}` : ''}
                                </small>
                            </div>
                            <div class="search-actions">
                                <button onclick="runSavedSearch(${search.id})" title="Run this search">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="delete" onclick="deleteSavedSearch(${search.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">No saved searches yet</p>';
                }
            } catch (error) {
                console.error('Error loading saved searches:', error);
            }
        }

        // Create saved search from current settings
        async function saveCurrentSearch() {
            const name = prompt('Enter a name for this search:');
            if (!name) return;

            const keywords = document.querySelector('input[name="keywords"]').value;
            const minPrice = document.querySelector('input[name="min_price"]').value;
            const maxPrice = document.querySelector('input[name="max_price"]').value;
            const location = document.querySelector('input[name="location"]').value;
            const radius = document.querySelector('input[name="radius"]').value;

            try {
                const response = await fetch('/api/saved-searches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        keywords: keywords,
                        min_price: minPrice ? parseInt(minPrice) : null,
                        max_price: maxPrice ? parseInt(maxPrice) : null,
                        location: location,
                        radius: radius ? parseInt(radius) : null,
                        notify_new: true
                    })
                });

                if (response.ok) {
                    showNotification('Search saved successfully!', 'success');
                    loadSavedSearches();
                } else {
                    throw new Error('Failed to save search');
                }
            } catch (error) {
                console.error('Error saving search:', error);
                showNotification('Failed to save search', 'error');
            }
        }

        // Delete a saved search
        async function deleteSavedSearch(searchId) {
            if (!confirm('Delete this saved search?')) return;

            try {
                const response = await fetch(`/api/saved-searches/${searchId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Search deleted', 'info');
                    loadSavedSearches();
                } else {
                    throw new Error('Failed to delete search');
                }
            } catch (error) {
                console.error('Error deleting search:', error);
                showNotification('Failed to delete search', 'error');
            }
        }

        // Run a saved search (load its settings)
        async function runSavedSearch(searchId) {
            try {
                const response = await fetch('/api/saved-searches');
                const data = await response.json();
                const search = data.searches.find(s => s.id === searchId);
                
                if (search) {
                    if (search.keywords) document.querySelector('input[name="keywords"]').value = search.keywords;
                    if (search.min_price) document.querySelector('input[name="min_price"]').value = search.min_price;
                    if (search.max_price) document.querySelector('input[name="max_price"]').value = search.max_price;
                    if (search.location) document.querySelector('input[name="location"]').value = search.location;
                    if (search.radius) document.querySelector('input[name="radius"]').value = search.radius;
                    
                    showNotification(`Loaded search: ${search.name}`, 'success');
                }
            } catch (error) {
                console.error('Error running saved search:', error);
                showNotification('Failed to load search', 'error');
            }
        }

        // Function to start polling
        function startPolling() {
            // Clear existing intervals to prevent memory leaks
            stopPolling();
            
            statusInterval = setInterval(updateStatus, 3000); // update bot status every 3s
            listingsInterval = setInterval(updateListings, 5000); // update listings every 5s
        }

        // Function to stop polling
        function stopPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            if (listingsInterval) {
                clearInterval(listingsInterval);
                listingsInterval = null;
            }
        }

        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startPolling();
            loadSavedSearches();
            
            // Add event listeners for favorite buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.favorite-btn')) {
                    e.preventDefault();
                    toggleFavorite();
                }
            });
        });

        // Stop polling when page is about to unload (prevents memory leaks)
        window.addEventListener('beforeunload', function() {
            stopPolling();
        });

        // Handle page visibility changes to pause/resume polling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopPolling();
            } else {
                startPolling();
            }
        });
    </script>
</body>
</html>
