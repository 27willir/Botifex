<!DOCTYPE html>
<html>
<head>
    <title>Botifex Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700;800&family=Rajdhani:wght@300;400;500;600;700&family=Roboto+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ====================== */
        /* GENERAL RESET & PAGE */
        /* ====================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Orbitron", "Exo 2", "Rajdhani", "Roboto Mono", "Courier New", monospace;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            color: #ffffff;
            display: flex;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 123, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: particleFloat 20s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        a { text-decoration: none; color: inherit; }

        /* ====================== */
        /* SIDEBAR */
        /* ====================== */
        .sidebar {
            width: 260px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 123, 255, 0.2);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 0 0 30px rgba(0, 123, 255, 0.1);
            position: relative;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 191, 255, 0.3) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 2px;
        }

        .logo-container {
            margin-bottom: 32px;
            padding-bottom: 16px;
            position: relative;
            text-align: center;
        }

        .logo-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #00bfff, transparent);
            border-radius: 1px;
        }

        .logo {
            max-width: 120px;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(0, 191, 255, 0.5));
            transition: all 0.3s ease;
        }

        .logo:hover {
            filter: drop-shadow(0 0 15px rgba(0, 191, 255, 0.8));
            transform: scale(1.05);
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.85);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .sidebar a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 191, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .sidebar a:hover::before {
            left: 100%;
        }

        .sidebar a:hover {
            background: rgba(0, 123, 255, 0.1);
            border-color: rgba(0, 191, 255, 0.3);
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(0, 191, 255, 0.15);
            color: #ffffff;
        }

        .sidebar a i {
            margin-right: 14px;
            color: #00bfff;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* ====================== */
        /* MAIN CONTENT */
        /* ====================== */
        .main {
            flex-grow: 1;
            padding: 40px 48px;
            background: rgba(10, 10, 15, 0.3);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 191, 255, 0.3) transparent;
        }

        .main::-webkit-scrollbar {
            width: 6px;
        }

        .main::-webkit-scrollbar-track {
            background: transparent;
        }

        .main::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 3px;
        }

        h2 {
            margin-bottom: 24px;
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        h2 i {
            color: #00bfff;
            margin-right: 12px;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
            font-size: 24px;
        }

        /* ====================== */
        /* CARDS */
        /* ====================== */
        .card {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* FORM STYLING */
        /* ====================== */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0 20px 0;
            border-radius: 12px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.8);
            color: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.9);
        }

        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input[type="submit"], button {
            background: linear-gradient(135deg, #007bff 0%, #00bfff 100%);
            color: #ffffff;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 191, 255, 0.3);
        }

        input[type="submit"]::before, button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        input[type="submit"]:hover::before, button:hover::before {
            left: 100%;
        }

        input[type="submit"]:hover, button:hover {
            background: linear-gradient(135deg, #00bfff 0%, #007bff 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 191, 255, 0.5);
        }

        input[type="submit"]:active, button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* TABLE STYLING */
        /* ====================== */
        table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        th, td {
            padding: 18px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 191, 255, 0.1);
        }

        th {
            background: rgba(0, 123, 255, 0.2);
            color: #00bfff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background: rgba(22, 33, 62, 0.3);
        }

        tr:hover {
            background: rgba(0, 191, 255, 0.1);
            transform: scale(1.002);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 191, 255, 0.1);
        }

        tr a {
            color: #00bfff;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        tr a:hover {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
        }

        /* ====================== */
        /* STATUS STYLING */
        /* ====================== */
        .status-running {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-stopped {
            color: #ff4757;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        /* ====================== */
        /* IMAGE STYLING */
        /* ====================== */
        img {
            border-radius: 8px;
            max-height: 80px;
            border: 2px solid rgba(0, 191, 255, 0.3);
            transition: all 0.3s ease;
        }

        img:hover {
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            transform: scale(1.05);
        }

        /* ====================== */
        /* RESPONSIVE TABLE SCROLL */
        /* ====================== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* ====================== */
        /* NOTIFICATION STYLING */
        /* ====================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .notification.error {
            background: rgba(255, 71, 87, 0.9);
            border: 1px solid rgba(255, 71, 87, 0.5);
        }

        .notification.success {
            background: rgba(0, 255, 136, 0.9);
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .notification.info {
            background: rgba(0, 191, 255, 0.9);
            border: 1px solid rgba(0, 191, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- ====================== -->
    <!-- SIDEBAR -->
    <!-- ====================== -->
    <div class="sidebar">
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/botifex-logo.svg') }}" alt="Botifex" class="logo">
        </div>
        <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
        <a href="{{ url_for('profile_page') }}"><i class="fas fa-user"></i> Profile</a>
        <a href="{{ url_for('favorites_page') }}"><i class="fas fa-star"></i> Favorites</a>
        <a href="/analytics"><i class="fas fa-chart-line"></i> Analytics</a>
        <a href="/selling"><i class="fas fa-dollar-sign"></i> Sell Items</a>
        <a href="#bot-control"><i class="fas fa-play-circle"></i> Bot Control</a>
        <a href="#recent-listings"><i class="fas fa-list"></i> Recent Listings</a>
        <a href="/api-docs" target="_blank"><i class="fas fa-book"></i> API Docs</a>
        {% if current_user.is_authenticated %}
            {% set user_data = None %}
            {% for u in [current_user.id] %}
                <!-- Check if user is admin -->
            {% endfor %}
        {% endif %}
        <a href="/admin" id="admin-link" style="display: none;"><i class="fas fa-user-shield"></i> Admin Panel</a>
        <a href="/subscription"><i class="fas fa-crown"></i> Subscription <span style="background: #667eea; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;">{{ user_tier|upper }}</span></a>
        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- ====================== -->
    <!-- MAIN CONTENT -->
    <!-- ====================== -->
    <div class="main">
        <!-- SETTINGS CARD -->
        <!-- SETTINGS CARD (merged into main page) -->
<div id="settings" class="card">
    <h2><i class="fas fa-cog"></i> Scraper Settings</h2>
    <form action="/update_settings" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        Location (City, State):<br>
        <input type="text" name="location" value="{{ settings.get('location','Boise, ID') }}"><br>
        
        Radius (miles):<br>
        <input type="number" name="radius" value="{{ settings.get('radius',50) }}"><br>

        Keywords (comma separated):<br>
        <input type="text" name="keywords" value="{% if settings.get('keywords') is string %}{{ settings.get('keywords') }}{% else %}{{ settings.get('keywords', 'Firebird,Camaro,Corvette') }}{% endif %}"><br>

        Min Price:<br>
        <input type="number" name="min_price" value="{{ settings.get('min_price',1000) }}"><br>

        Max Price:<br>
        <input type="number" name="max_price" value="{{ settings.get('max_price',30000) }}"><br>

        Check Interval (seconds):<br>
        <input type="number" name="interval" value="{{ settings.get('interval',60) }}"><br>

        <input type="submit" value="Update Settings">
    </form>
</div>
        <!-- BOT CONTROL CARD -->
        <div id="bot-control" class="card">
            <h2><i class="fas fa-play-circle"></i> Bot Control</h2>
            <table>
                <tr>
                    <th>Site</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                {% for site, stat in status.items() %}
                <tr>
                    <td>{{ site.capitalize() }}</td>
                    <td>
                        {% if stat %}
                            <span class="status-running">Running</span>
                        {% else %}
                            <span class="status-stopped">Stopped</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if not stat %}
                            <a href="/start/{{ site }}"><button>Start</button></a>
                        {% else %}
                            <a href="/stop/{{ site }}"><button>Stop</button></a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <!-- RECENT LISTINGS CARD -->
        <div id="recent-listings" class="card table-container">
            <h2><i class="fas fa-list"></i> Recent Listings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Source</th>
                        <th>Link</th>
                        <th>Image</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="listings_table">
                    {% for l in listings %}
                    <tr>
                        <td>{{ l[0] }}</td>
                        <td>{{ l[1] }}</td>
                        <td>{{ l[4] }}</td>
                        <td><a href="{{ l[2] }}" target="_blank">Link</a></td>
                        <td>{% if l[3] %}<img src="{{ l[3] }}" width="80">{% endif %}</td>
                        <td>{{ l[5] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ====================== -->
    <!-- LIVE UPDATES SCRIPT -->
    <!-- ====================== -->
    <script>
        // Check if user is admin and show admin link
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                // Admin link visibility will be handled by Flask backend
                // For now, check if user has admin role via user info
            })
            .catch(err => console.log('Could not check admin status'));

        // Keep track of existing listings to detect new ones
        let knownListings = new Set();
        const listingsTable = document.getElementById("listings_table");
        if (listingsTable) {
            listingsTable.querySelectorAll("tr").forEach(tr => {
                const linkElement = tr.querySelector("a");
                if (linkElement && linkElement.href) {
                    knownListings.add(linkElement.href);
                }
            });
        }

        // Store interval IDs for cleanup
        let statusInterval = null;
        let listingsInterval = null;

        // Function to update bot status
        function updateStatus() {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch("/api/status", { signal: controller.signal })
                .then(res => {
                    clearTimeout(timeoutId);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || typeof data !== 'object') {
                        throw new Error('Invalid response data');
                    }
                    
                    const botControlTable = document.querySelector("#bot-control table");
                    if (!botControlTable) {
                        console.warn("Bot control table not found");
                        return;
                    }
                    
                    for (const [site, running] of Object.entries(data)) {
                        if (!site) continue;
                        
                        // Fix: Use proper DOM traversal with null checks
                        const rows = botControlTable.querySelectorAll("tr");
                        let targetRow = null;
                        
                        for (const row of rows) {
                            const firstCell = row.querySelector("td:first-child");
                            if (firstCell && firstCell.textContent) {
                                const cellText = firstCell.textContent.trim().toLowerCase();
                                const siteName = site.toLowerCase();
                                if (cellText === siteName) {
                                    targetRow = row;
                                    break;
                                }
                            }
                        }
                        
                        if (!targetRow) continue;
                        
                        const cells = targetRow.querySelectorAll("td");
                        if (cells && cells.length >= 3) {
                            const statusCell = cells[1];
                            const actionCell = cells[2];
                            
                            if (statusCell && actionCell) {
                                statusCell.innerHTML = running
                                    ? '<span class="status-running">Running</span>'
                                    : '<span class="status-stopped">Stopped</span>';
                                actionCell.innerHTML = running
                                    ? `<a href="/stop/${escapeHtml(site)}"><button type="button">Stop</button></a>`
                                    : `<a href="/start/${escapeHtml(site)}"><button type="button">Start</button></a>`;
                            }
                        }
                    }
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Status update timeout");
                    } else {
                        console.error("Status update error:", err);
                    }
                    // Don't show notification for every failed update to avoid spam
                });
        }

        // Function to update listings
        function updateListings() {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch("/api/listings", { signal: controller.signal })
                .then(res => {
                    clearTimeout(timeoutId);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || !Array.isArray(data.listings)) {
                        throw new Error('Invalid listings data');
                    }
                    
                    const tbody = document.getElementById("listings_table");
                    if (!tbody) {
                        console.warn('Listings table not found');
                        return;
                    }
                    
                    tbody.innerHTML = ""; // clear current rows
                    
                    data.listings.forEach(l => {
                        if (!Array.isArray(l) || l.length < 6) {
                            console.warn('Invalid listing data:', l);
                            return;
                        }
                        
                        const link = l[2] || '';
                        const tr = document.createElement("tr");
                        
                        // Create cells with proper escaping
                        const titleCell = document.createElement("td");
                        titleCell.textContent = l[0] || '';
                        
                        const priceCell = document.createElement("td");
                        priceCell.textContent = l[1] || '';
                        
                        const sourceCell = document.createElement("td");
                        sourceCell.textContent = l[4] || '';
                        
                        const linkCell = document.createElement("td");
                        if (link) {
                            const linkAnchor = document.createElement("a");
                            linkAnchor.href = link;
                            linkAnchor.textContent = "Link";
                            linkAnchor.target = "_blank";
                            linkAnchor.rel = "noopener noreferrer";
                            linkCell.appendChild(linkAnchor);
                        }
                        
                        const imageCell = document.createElement("td");
                        if (l[3]) {
                            const img = document.createElement("img");
                            img.src = l[3];
                            img.width = 80;
                            img.alt = "Listing image";
                            img.onerror = function() { this.style.display = 'none'; };
                            imageCell.appendChild(img);
                        }
                        
                        const dateCell = document.createElement("td");
                        dateCell.textContent = l[5] || '';
                        
                        // Append all cells
                        tr.appendChild(titleCell);
                        tr.appendChild(priceCell);
                        tr.appendChild(sourceCell);
                        tr.appendChild(linkCell);
                        tr.appendChild(imageCell);
                        tr.appendChild(dateCell);
                        
                        // Highlight new listings
                        if (link && !knownListings.has(link)) {
                            tr.style.backgroundColor = "#00ff9944";
                            setTimeout(() => {
                                if (tr.style) {
                                    tr.style.backgroundColor = "";
                                }
                            }, 3000);
                            knownListings.add(link);
                        }
                        
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Listings update timeout");
                    } else {
                        console.error("Listings update error:", err);
                    }
                    // Don't show notification for every failed update
                });
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Function to start polling
        function startPolling() {
            // Clear existing intervals to prevent memory leaks
            stopPolling();
            
            statusInterval = setInterval(updateStatus, 3000); // update bot status every 3s
            listingsInterval = setInterval(updateListings, 5000); // update listings every 5s
        }

        // Function to stop polling
        function stopPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            if (listingsInterval) {
                clearInterval(listingsInterval);
                listingsInterval = null;
            }
        }

        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startPolling();
        });

        // Stop polling when page is about to unload (prevents memory leaks)
        window.addEventListener('beforeunload', function() {
            stopPolling();
        });

        // Handle page visibility changes to pause/resume polling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopPolling();
            } else {
                startPolling();
            }
        });
    </script>
</body>
</html>
