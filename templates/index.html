<!DOCTYPE html>
<html>
<head>
    <title>Botifex Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ====================== */
        /* GENERAL RESET & PAGE */
        /* ====================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Poppins", "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            color: #ffffff;
            display: flex;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 123, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 123, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: particleFloat 20s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        a { text-decoration: none; color: inherit; }

        /* ====================== */
        /* SIDEBAR */
        /* ====================== */
        .sidebar {
            width: 268px;
            padding: 32px 26px 28px;
            background: linear-gradient(195deg, rgba(17, 20, 36, 0.94) 0%, rgba(8, 10, 22, 0.9) 100%);
            border-right: 1px solid rgba(99, 102, 241, 0.18);
            box-shadow: 12px 0 36px rgba(8, 12, 24, 0.28);
            border-radius: 0 28px 28px 0;
            display: flex;
            flex-direction: column;
            gap: 28px;
            position: relative;
            overflow-y: auto;
            color: rgba(226, 232, 240, 0.94);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 100% at -20% 0%, rgba(56, 189, 248, 0.18), transparent 60%);
            pointer-events: none;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 1px solid rgba(148, 163, 184, 0.05);
            border-left: none;
            border-radius: 0 28px 28px 0;
            pointer-events: none;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.18);
            border-radius: 3px;
        }

        .sidebar-inner {
            display: flex;
            flex-direction: column;
            gap: 28px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .sidebar-header {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding-bottom: 18px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .sidebar-logo-link {
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .sidebar-logo {
            max-width: 130px;
            height: auto;
            filter: drop-shadow(0 0 12px rgba(56, 189, 248, 0.24));
            transition: transform 0.35s ease, filter 0.35s ease;
        }

        .sidebar-logo-link:hover .sidebar-logo {
            transform: translateY(-1px) scale(1.04);
            filter: drop-shadow(0 0 16px rgba(56, 189, 248, 0.36));
        }

        .sidebar-heading {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.6px;
            color: rgba(248, 250, 252, 0.92);
        }

        .sidebar-tagline {
            font-size: 12px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.6);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 26px;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.4px;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.52);
            padding-left: 4px;
        }

        .sidebar-links {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: rgba(226, 232, 240, 0.88);
            font-weight: 500;
            letter-spacing: 0.2px;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.008);
            position: relative;
            transition: all 0.35s ease;
        }

        .sidebar-link::before {
            content: '';
            position: absolute;
            top: 10px;
            bottom: 10px;
            left: 8px;
            width: 2px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(56, 189, 248, 0.55), rgba(129, 140, 248, 0.55));
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .sidebar-link i {
            font-size: 16px;
            width: 20px;
            text-align: center;
            color: rgba(165, 180, 252, 0.68);
        }

        .sidebar-link span {
            flex: 1;
        }

        .sidebar-link:hover,
        .sidebar-link:focus-visible {
            background: linear-gradient(120deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.08));
            border-color: rgba(99, 102, 241, 0.22);
            color: rgba(248, 250, 252, 0.95);
            transform: translateX(6px);
            box-shadow: 0 14px 32px rgba(76, 106, 255, 0.14);
        }

        .sidebar-link:hover::before,
        .sidebar-link:focus-visible::before,
        .sidebar-link.active::before {
            opacity: 1;
        }

        .sidebar-link.active {
            background: linear-gradient(120deg, rgba(79, 70, 229, 0.2), rgba(14, 165, 233, 0.12));
            border-color: rgba(99, 102, 241, 0.32);
            color: rgba(248, 250, 252, 0.98);
            box-shadow: 0 14px 32px rgba(76, 106, 255, 0.16);
        }

        .sidebar-link.active i {
            color: rgba(199, 210, 254, 0.82);
        }

        .sidebar-pill {
            margin-left: auto;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.22);
            color: rgba(199, 210, 254, 0.9);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .sidebar-link-external {
            font-size: 12px;
            margin-left: 6px;
            color: rgba(148, 163, 184, 0.5);
        }

        .sidebar-link:hover .sidebar-link-external,
        .sidebar-link:focus-visible .sidebar-link-external {
            color: rgba(226, 232, 240, 0.7);
        }

        .sidebar-link.is-hidden {
            display: none;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .sidebar-footer .sidebar-link {
            background: rgba(255, 255, 255, 0.015);
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
                padding: 28px 22px 24px;
            }
        }

        /* ====================== */
        /* MAIN CONTENT */
        /* ====================== */
        .main {
            flex-grow: 1;
            padding: 40px 48px;
            background: rgba(10, 10, 15, 0.3);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 191, 255, 0.3) transparent;
        }

        .main::-webkit-scrollbar {
            width: 6px;
        }

        .main::-webkit-scrollbar-track {
            background: transparent;
        }

        .main::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 3px;
        }

        .feed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .feed-section {
            background: rgba(16, 22, 40, 0.85);
            border: 1px solid rgba(0, 191, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        }

        .feed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .feed-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            margin: 0;
        }

        .feed-header button,
        .feed-header select {
            background: rgba(0, 191, 255, 0.15);
            border: 1px solid rgba(0, 191, 255, 0.35);
            color: #ffffff;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .feed-header button:hover,
        .feed-header select:hover {
            background: rgba(0, 191, 255, 0.3);
            border-color: rgba(0, 191, 255, 0.6);
        }

        .feed-list,
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .feed-item,
        .notification-item {
            display: flex;
            gap: 16px;
            background: rgba(9, 14, 26, 0.9);
            border: 1px solid rgba(0, 191, 255, 0.12);
            border-radius: 14px;
            padding: 16px;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }

        .feed-item:hover,
        .notification-item:hover {
            border-color: rgba(0, 191, 255, 0.4);
            transform: translateY(-2px);
        }

        .feed-item-icon,
        .notification-icon {
            flex-shrink: 0;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: rgba(0, 191, 255, 0.18);
            color: #00d8ff;
            font-size: 18px;
        }

        .feed-item-body,
        .notification-body {
            flex: 1;
        }

        .feed-item-top,
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 6px;
        }

        .feed-label,
        .notification-label {
            font-weight: 600;
            letter-spacing: 0.3px;
            color: #9be7ff;
            text-transform: uppercase;
            font-size: 12px;
        }

        .feed-time,
        .notification-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
        }

        .feed-item-content,
        .notification-content {
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            line-height: 1.6;
        }

        .feed-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }

        .feed-empty {
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            padding: 20px 0;
        }

        .notification-group + .notification-group {
            margin-top: 20px;
            border-top: 1px solid rgba(0, 191, 255, 0.12);
            padding-top: 16px;
        }

        .notification-group h4 {
            margin-bottom: 12px;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.5px;
        }

        .notification-item.unread {
            border-color: rgba(0, 191, 255, 0.5);
            background: rgba(13, 22, 38, 0.92);
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .notification-actions button {
            background: rgba(0, 191, 255, 0.18);
            border: 1px solid rgba(0, 191, 255, 0.3);
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .notification-actions button:hover {
            background: rgba(0, 191, 255, 0.35);
            border-color: rgba(0, 191, 255, 0.6);
        }

        .feed-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .feed-actions button {
            background: rgba(0, 191, 255, 0.15);
            border: 1px solid rgba(0, 191, 255, 0.4);
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .feed-actions button:hover {
            background: rgba(0, 191, 255, 0.35);
        }

        .feed-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            padding: 0 8px;
            height: 22px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(255, 87, 175, 0.4);
            color: #ffffff;
            border: 1px solid rgba(255, 87, 175, 0.6);
        }

        @media (max-width: 1024px) {
            .feed-grid {
                grid-template-columns: 1fr;
            }
        }

        h2 {
            margin-bottom: 24px;
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        h2 i {
            color: #00bfff;
            margin-right: 12px;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
            font-size: 24px;
        }

        /* ====================== */
        /* CARDS */
        /* ====================== */
        .card {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 191, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* FORM STYLING */
        /* ====================== */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0 20px 0;
            border-radius: 12px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.8);
            color: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            background: rgba(22, 33, 62, 0.9);
        }

        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input[type="submit"], button {
            background: linear-gradient(135deg, #007bff 0%, #00bfff 100%);
            color: #ffffff;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 191, 255, 0.3);
        }

        input[type="submit"]::before, button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        input[type="submit"]:hover::before, button:hover::before {
            left: 100%;
        }

        input[type="submit"]:hover, button:hover {
            background: linear-gradient(135deg, #00bfff 0%, #007bff 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 191, 255, 0.5);
        }

        input[type="submit"]:active, button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        /* ====================== */
        /* TABLE STYLING */
        /* ====================== */
        table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        th, td {
            padding: 18px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 191, 255, 0.1);
        }

        th {
            background: rgba(0, 123, 255, 0.2);
            color: #00bfff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background: rgba(22, 33, 62, 0.3);
        }

        tr:hover {
            background: rgba(0, 191, 255, 0.1);
            transform: scale(1.002);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 191, 255, 0.1);
        }

        tr a {
            color: #00bfff;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        tr a:hover {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
        }

        /* ====================== */
        /* STATUS STYLING */
        /* ====================== */
        .status-running {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-stopped {
            color: #ff4757;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        /* ====================== */
        /* IMAGE STYLING */
        /* ====================== */
        img {
            border-radius: 8px;
            max-height: 80px;
            border: 2px solid rgba(0, 191, 255, 0.3);
            transition: all 0.3s ease;
        }

        img:hover {
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            transform: scale(1.05);
        }

        /* ====================== */
        /* RESPONSIVE TABLE SCROLL */
        /* ====================== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* ====================== */
        /* NOTIFICATION STYLING */
        /* ====================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .notification.error {
            background: rgba(255, 71, 87, 0.9);
            border: 1px solid rgba(255, 71, 87, 0.5);
        }

        .notification.success {
            background: rgba(0, 255, 136, 0.9);
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .notification.info {
            background: rgba(0, 191, 255, 0.9);
            border: 1px solid rgba(0, 191, 255, 0.5);
        }

        /* Favorite Button Styles */
        .favorite-btn {
            background: transparent;
            border: 1px solid rgba(0, 191, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .favorite-btn:hover {
            background: rgba(0, 191, 255, 0.1);
            border-color: rgba(0, 191, 255, 0.6);
            color: #00bfff;
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ffd700;
            border-color: #ffd700;
        }

        .favorite-btn.favorited i {
            font-weight: 900;
        }

        /* Saved Searches Section */
        .saved-searches-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(20, 20, 35, 0.95);
            border-radius: 12px;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .saved-search-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 123, 255, 0.05);
            border: 1px solid rgba(0, 123, 255, 0.2);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .saved-search-item:hover {
            background: rgba(0, 123, 255, 0.1);
            border-color: rgba(0, 123, 255, 0.4);
            transform: translateX(4px);
        }

        .search-info {
            flex: 1;
        }

        .search-actions {
            display: flex;
            gap: 10px;
        }

        .search-actions button {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-actions button:hover {
            background: rgba(0, 191, 255, 0.2);
            border-color: rgba(0, 191, 255, 0.6);
        }

        .search-actions button.delete:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: rgba(255, 68, 68, 0.6);
            color: #ff4444;
        }
    </style>
</head>
<body>
    <!-- ====================== -->
    <!-- SIDEBAR -->
    <!-- ====================== -->
    <div class="sidebar">
        <div class="sidebar-inner">
            <div class="sidebar-header">
                <a href="{{ url_for('dashboard') }}" class="sidebar-logo-link">
                    <img src="{{ url_for('static', filename='images/botifex-logo.svg') }}" alt="Botifex" class="sidebar-logo">
                </a>
                <div class="sidebar-heading">
                    <span class="sidebar-title">Control Center</span>
                    <span class="sidebar-tagline">Monitor • Discover • Act faster</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <p class="sidebar-section-title">Overview</p>
                    <div class="sidebar-links">
                        <a href="{{ url_for('dashboard') }}" class="sidebar-link"><i class="fas fa-home"></i><span>Dashboard</span></a>
                        <a href="{{ url_for('landing', preview='1') }}" class="sidebar-link" target="_blank" rel="noopener"><i class="fas fa-globe"></i><span>Landing Page</span></a>
                        <a href="#settings" class="sidebar-link"><i class="fas fa-cog"></i><span>Quick Settings</span></a>
                        <a href="{{ url_for('profile_page') }}" class="sidebar-link"><i class="fas fa-user"></i><span>Profile</span></a>
                        <a href="{{ url_for('favorites_page') }}" class="sidebar-link"><i class="fas fa-star"></i><span>Favorites</span></a>
                    </div>
                </div>

                <div class="sidebar-section">
                    <p class="sidebar-section-title">Engagement</p>
                    <div class="sidebar-links">
                        <a href="{{ url_for('messages_page') }}" class="sidebar-link"><i class="fas fa-comments"></i><span>Messages</span></a>
                        <a href="#activity-feed" class="sidebar-link"><i class="fas fa-stream"></i><span>Activity Feed</span></a>
                        <a href="#server-highlights" class="sidebar-link"><i class="fas fa-fire"></i><span>Server Highlights</span></a>
                        <a href="#notification-center" class="sidebar-link"><i class="fas fa-rss"></i><span>Notifications</span></a>
                    </div>
                </div>

                <div class="sidebar-section">
                    <p class="sidebar-section-title">Growth</p>
                    <div class="sidebar-links">
                        <a href="{{ url_for('servers_discover_page') }}" class="sidebar-link"><i class="fas fa-users"></i><span>Community Servers</span></a>
                        <a href="{{ url_for('servers_create_page') }}" class="sidebar-link"><i class="fas fa-plus-circle"></i><span>Create Server</span></a>
                        <a href="{{ url_for('alerts_page') }}" class="sidebar-link"><i class="fas fa-bell"></i><span>Price Alerts</span></a>
                        <a href="/analytics" class="sidebar-link"><i class="fas fa-chart-line"></i><span>Analytics</span></a>
                        <a href="/selling" class="sidebar-link"><i class="fas fa-dollar-sign"></i><span>Sell Items</span></a>
                        <a href="#bot-control" class="sidebar-link"><i class="fas fa-play-circle"></i><span>Bot Control</span></a>
                        <a href="#recent-listings" class="sidebar-link"><i class="fas fa-list"></i><span>Recent Listings</span></a>
                        <a href="/api-docs" target="_blank" rel="noopener" class="sidebar-link"><i class="fas fa-book"></i><span>API Docs <i class="fas fa-arrow-up-right-from-square sidebar-link-external"></i></span></a>
                    </div>
                </div>

                <div class="sidebar-section">
                    <p class="sidebar-section-title">Management</p>
                    <div class="sidebar-links">
                        <a href="{{ url_for('updates_page') }}" class="sidebar-link"><i class="fas fa-newspaper"></i><span>Updates</span></a>
                        {% if current_user.is_authenticated %}
                            {% set user_data = None %}
                            {% for u in [current_user.id] %}
                                <!-- Check if user is admin -->
                            {% endfor %}
                        {% endif %}
                        <a href="/admin" id="admin-link" class="sidebar-link" style="display: none;"><i class="fas fa-user-shield"></i><span>Admin Panel</span></a>
                    </div>
                </div>
            </nav>
        </div>

        <div class="sidebar-footer">
            <a href="/subscription" class="sidebar-link">
                <i class="fas fa-crown"></i>
                <span>Subscription</span>
                <span class="sidebar-pill">{{ user_tier|upper }}</span>
            </a>
            <a href="/logout" class="sidebar-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- ====================== -->
    <!-- MAIN CONTENT -->
    <!-- ====================== -->
    <div class="main">
        <div class="feed-grid">
            <div id="activity-feed" class="feed-section">
                <div class="feed-header">
                    <h2><i class="fas fa-stream"></i> Activity Feed</h2>
                    <div class="feed-actions">
                        <button id="refresh-home-feed" type="button"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                </div>
                <div id="activity-feed-list" class="feed-list">
                    <p class="feed-empty">Loading activity feed…</p>
                </div>
            </div>
            <div id="server-highlights" class="feed-section">
                <div class="feed-header">
                    <h2><i class="fas fa-fire"></i> Server Highlights</h2>
                    <div class="feed-actions">
                        <select id="server-feed-selector">
                            <option value="">Select a server</option>
                        </select>
                        <button id="refresh-server-feed" type="button"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                </div>
                <div id="server-feed-list" class="feed-list">
                    <p class="feed-empty">Join a server to see highlights.</p>
                </div>
            </div>
            <div id="notification-center" class="feed-section">
                <div class="feed-header">
                    <h2><i class="fas fa-rss"></i> Notification Center <span id="notifications-count" class="feed-count-badge">0</span></h2>
                    <div class="feed-actions">
                        <button id="notifications-refresh" type="button"><i class="fas fa-sync"></i> Refresh</button>
                        <button id="notifications-mark-all" type="button"><i class="fas fa-check"></i> Mark All Read</button>
                    </div>
                </div>
                <div id="notification-groups">
                    <div class="notification-group">
                        <h4>Today</h4>
                        <div id="notifications-today" class="notification-list">
                            <p class="feed-empty">Loading notifications…</p>
                        </div>
                    </div>
                    <div class="notification-group">
                        <h4>Earlier</h4>
                        <div id="notifications-earlier" class="notification-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS CARD -->
        <!-- SETTINGS CARD (merged into main page) -->
<div id="settings" class="card">
    <h2><i class="fas fa-cog"></i> Search Settings</h2>
    <form action="/update_settings" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        Location (City, State):<br>
        <input type="text" name="location" value="{{ settings.get('location','Boise, ID') }}"><br>
        
        Radius (miles):<br>
        <input type="number" name="radius" value="{{ settings.get('radius',50) }}"><br>

        Keywords (comma separated):<br>
        <input type="text" name="keywords" value="{% if settings.get('keywords') is string %}{{ settings.get('keywords') }}{% else %}{{ settings.get('keywords', 'Firebird,Camaro,Corvette') }}{% endif %}"><br>

        Min Price:<br>
        <input type="number" name="min_price" value="{{ settings.get('min_price',1000) }}"><br>

        Max Price:<br>
        <input type="number" name="max_price" value="{{ settings.get('max_price',30000) }}"><br>

        Check Interval:<br>
        <p style="margin: 6px 0 16px; color: rgba(255, 255, 255, 0.7);">
            {{ min_refresh_interval }} minute{% if min_refresh_interval != 1 %}s{% endif %} (automatically managed by your {{ user_tier|capitalize }} plan)
        </p>

        <input type="submit" value="Update Settings">
        <button type="button" onclick="saveCurrentSearch()" style="margin-left: 10px; background: linear-gradient(135deg, #28a745, #20c997); border: none; padding: 10px 20px; border-radius: 8px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
            <i class="fas fa-save"></i> Save as Search
        </button>
        {% if user_tier in ['standard', 'pro'] %}
        <button type="button" id="searchExistingButton" onclick="searchExistingListings()" style="margin-left: 10px; background: linear-gradient(135deg, #17a2b8, #0dcaf0); border: none; padding: 10px 20px; border-radius: 8px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
            <i class="fas fa-search"></i> Search Existing Listings
        </button>
        {% else %}
        <button type="button" onclick="window.location.href='/subscription/plans'" title="Upgrade to Standard to search existing listings" style="margin-left: 10px; background: linear-gradient(135deg, #6c757d, #868e96); border: none; padding: 10px 20px; border-radius: 8px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
            <i class="fas fa-search"></i> Search Existing Listings
        </button>
        {% endif %}
    </form>

    <!-- Saved Searches Section -->
    <div class="saved-searches-section">
        <h3 style="margin-bottom: 15px; color: #00bfff;">
            <i class="fas fa-bookmark"></i> Saved Searches
        </h3>
        <div id="savedSearchesList">
            <p style="text-align: center; color: rgba(255,255,255,0.5);">Loading...</p>
        </div>
    </div>
</div>
        <!-- BOT CONTROL CARD -->
        <div id="bot-control" class="card">
            <h2><i class="fas fa-play-circle"></i> Bot Control</h2>
            
            <!-- Start/Stop All Buttons -->
            <div style="margin-bottom: 20px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="/start-all" title="Start all monitors available in your {{ user_tier|capitalize }} plan">
                    <button style="background: linear-gradient(135deg, #28a745, #20c997); font-size: 16px; padding: 14px 28px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-rocket"></i> Start All Monitors
                    </button>
                </a>
                <a href="/stop-all" title="Stop all monitors available in your {{ user_tier|capitalize }} plan">
                    <button style="background: linear-gradient(135deg, #dc3545, #c82333); font-size: 16px; padding: 14px 28px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-stop-circle"></i> Stop All Monitors
                    </button>
                </a>
            </div>
            <p style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: -10px; margin-bottom: 15px;">
                <i class="fas fa-info-circle"></i> Start/Stop All will only affect platforms available in your <strong>{{ user_tier|capitalize }}</strong> plan
            </p>
            
            <div class="table-container">
            <table>
                <tr>
                    <th>Site</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                {% for site, stat in status.items() %}
                <tr>
                    <td>
                        {{ site.capitalize() }}
                        {% if (site == 'poshmark' or site == 'mercari') and user_tier != 'pro' %}
                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 5px; color: white;">
                                <i class="fas fa-crown"></i> PRO
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stat %}
                            <span class="status-running">Running</span>
                        {% else %}
                            <span class="status-stopped">Stopped</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if (site == 'poshmark' or site == 'mercari') and user_tier != 'pro' %}
                            <a href="/subscription/plans"><button style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white;">
                                <i class="fas fa-lock"></i> Upgrade to Pro
                            </button></a>
                        {% elif not stat %}
                            <a href="/start/{{ site }}"><button>Start</button></a>
                        {% else %}
                            <a href="/stop/{{ site }}"><button>Stop</button></a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            </div>
        </div>

        <!-- RECENT LISTINGS CARD -->
        <div id="recent-listings" class="card table-container">
            <h2><i class="fas fa-list"></i> Recent Listings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Source</th>
                        <th>Link</th>
                        <th>Image</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="listings_table">
                    {% for l in listings %}
                    <tr data-listing-id="{{ l[0] }}">
                        <td>{{ l[1] }}</td>
                        <td>{{ l[2] }}</td>
                        <td>{{ l[5] }}</td>
                        <td><a href="{{ l[3] }}" target="_blank">Link</a></td>
                        <td>{% if l[4] %}<img src="{{ l[4] }}" width="80">{% endif %}</td>
                        <td>{{ l[6] }}</td>
                        <td>
                            <button class="favorite-btn" 
                                    data-id="{{ l[0] }}" 
                                    data-title="{{ l[1] }}" 
                                    data-price="{{ l[2] }}" 
                                    data-link="{{ l[3] }}" 
                                    data-image="{{ l[4] or '' }}" 
                                    data-source="{{ l[5] }}" 
                                    title="Add to Favorites">
                                <i class="far fa-star"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ====================== -->
    <!-- LIVE UPDATES SCRIPT -->
    <!-- ====================== -->
    <script>
        // Check if user is admin and show admin link
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                // Admin link visibility will be handled by Flask backend
                // For now, check if user has admin role via user info
            })
            .catch(err => console.log('Could not check admin status'));

        // Keep track of existing listings to detect new ones
        let knownListings = new Set();
        const listingsTable = document.getElementById("listings_table");
        if (listingsTable) {
            listingsTable.querySelectorAll("tr").forEach(tr => {
                const linkElement = tr.querySelector("a");
                if (linkElement && linkElement.href) {
                    knownListings.add(linkElement.href);
                }
            });
        }

        const canSearchExistingListings = {{ (user_tier in ['standard', 'pro']) | tojson }};
        const manualSearchResetMs = 60000;
        let manualSearchActive = false;
        let manualSearchResetTimer = null;

        // Store interval IDs for cleanup
        let statusInterval = null;
        let listingsInterval = null;
        const feedState = {
            servers: [],
            selectedServer: null,
        };

        // Function to update bot status with health information
        function updateStatus() {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            // Fetch both status and health in parallel
            Promise.all([
                fetch("/api/status", { signal: controller.signal }).then(res => res.ok ? res.json() : {}),
                fetch("/api/scraper-health", { signal: controller.signal }).then(res => res.ok ? res.json() : {})
            ])
                .then(([statusData, healthData]) => {
                    clearTimeout(timeoutId);
                    
                    const botControlTable = document.querySelector("#bot-control table");
                    if (!botControlTable) {
                        console.warn("Bot control table not found");
                        return;
                    }
                    
                    for (const [site, running] of Object.entries(statusData)) {
                        if (!site) continue;
                        
                        // Get health information for this site
                        const health = healthData[site] || {};
                        const healthStatus = health.status || 'unknown';
                        const lastError = health.last_error;
                        
                        // Fix: Use proper DOM traversal with null checks
                        const rows = botControlTable.querySelectorAll("tr");
                        let targetRow = null;
                        
                        for (const row of rows) {
                            const firstCell = row.querySelector("td:first-child");
                            if (firstCell && firstCell.textContent) {
                                // Extract just the site name, ignoring badges
                                const cellText = firstCell.textContent.trim().toLowerCase().split(/\s+/)[0];
                                const siteName = site.toLowerCase();
                                if (cellText === siteName) {
                                    targetRow = row;
                                    break;
                                }
                            }
                        }
                        
                        if (!targetRow) continue;
                        
                        const cells = targetRow.querySelectorAll("td");
                        if (cells && cells.length >= 3) {
                            const statusCell = cells[1];
                            const actionCell = cells[2];
                            
                            if (statusCell && actionCell) {
                                // Build status HTML with health indicator
                                let statusHTML = '';
                                let statusTitle = '';
                                
                                if (running) {
                                    if (healthStatus === 'healthy') {
                                        statusHTML = '<span class="status-running" title="Running normally">✓ Running</span>';
                                    } else if (healthStatus === 'degraded') {
                                        statusHTML = '<span class="status-running" style="color: #ffaa00;" title="Running with some errors">⚠ Running</span>';
                                        statusTitle = lastError ? `Last error: ${lastError.message}` : '';
                                    } else if (healthStatus === 'unhealthy') {
                                        statusHTML = '<span class="status-running" style="color: #ff6600;" title="Running with many errors">⚠ Unhealthy</span>';
                                        statusTitle = lastError ? `Last error: ${lastError.message}` : '';
                                    } else {
                                        statusHTML = '<span class="status-running">Running</span>';
                                    }
                                } else {
                                    statusHTML = '<span class="status-stopped">Stopped</span>';
                                    if (lastError) {
                                        statusTitle = `Last error: ${lastError.message}`;
                                    }
                                }
                                
                                statusCell.innerHTML = statusHTML;
                                if (statusTitle) {
                                    statusCell.title = statusTitle;
                                }
                                
                                actionCell.innerHTML = running
                                    ? `<a href="/stop/${escapeHtml(site)}"><button type="button">Stop</button></a>`
                                    : `<a href="/start/${escapeHtml(site)}"><button type="button">Start</button></a>`;
                            }
                        }
                    }
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Status update timeout");
                    } else {
                        console.error("Status update error:", err);
                    }
                    // Don't show notification for every failed update to avoid spam
                });
        }

        function renderListingsTable(listings, options = {}) {
            const {
                highlightNew = true,
                emptyMessage = 'No listings available.'
            } = options;

            const tbody = document.getElementById("listings_table");
            if (!tbody) {
                console.warn('Listings table not found');
                return;
            }

            tbody.innerHTML = "";

            if (!Array.isArray(listings) || listings.length === 0) {
                const emptyRow = document.createElement("tr");
                const emptyCell = document.createElement("td");
                emptyCell.colSpan = 7;
                emptyCell.textContent = emptyMessage;
                emptyCell.style.textAlign = "center";
                emptyCell.style.color = "rgba(255, 255, 255, 0.6)";
                emptyRow.appendChild(emptyCell);
                tbody.appendChild(emptyRow);
                return;
            }

            listings.forEach(l => {
                if (!Array.isArray(l) || l.length < 7) {
                    console.warn('Invalid listing data:', l);
                    return;
                }

                const [listingId, title, price, link, imageUrl, source, createdAt] = l;

                const tr = document.createElement("tr");
                tr.setAttribute('data-listing-id', listingId || '');

                const titleCell = document.createElement("td");
                titleCell.textContent = title || '';

                const priceCell = document.createElement("td");
                priceCell.textContent = price || '';

                const sourceCell = document.createElement("td");
                sourceCell.textContent = source || '';

                const linkCell = document.createElement("td");
                if (link) {
                    const linkAnchor = document.createElement("a");
                    linkAnchor.href = link;
                    linkAnchor.textContent = "Link";
                    linkAnchor.target = "_blank";
                    linkAnchor.rel = "noopener noreferrer";
                    linkCell.appendChild(linkAnchor);
                }

                const imageCell = document.createElement("td");
                if (imageUrl) {
                    const img = document.createElement("img");
                    img.src = imageUrl;
                    img.width = 80;
                    img.alt = "Listing image";
                    img.onerror = function() { this.style.display = 'none'; };
                    imageCell.appendChild(img);
                }

                const dateCell = document.createElement("td");
                dateCell.textContent = createdAt || '';

                const actionsCell = document.createElement("td");
                const favoriteBtn = document.createElement("button");
                favoriteBtn.className = "favorite-btn";
                favoriteBtn.title = "Add to Favorites";
                favoriteBtn.onclick = function() {
                    toggleFavorite(listingId, title, price, link, imageUrl, source);
                };
                const icon = document.createElement("i");
                icon.className = "far fa-star";
                favoriteBtn.appendChild(icon);
                actionsCell.appendChild(favoriteBtn);

                tr.appendChild(titleCell);
                tr.appendChild(priceCell);
                tr.appendChild(sourceCell);
                tr.appendChild(linkCell);
                tr.appendChild(imageCell);
                tr.appendChild(dateCell);
                tr.appendChild(actionsCell);

                if (link) {
                    const alreadyKnown = knownListings.has(link);
                    if (highlightNew && !alreadyKnown) {
                        tr.style.backgroundColor = "#00ff9944";
                        setTimeout(() => {
                            if (tr.style) {
                                tr.style.backgroundColor = "";
                            }
                        }, 3000);
                    }
                    knownListings.add(link);
                }

                tbody.appendChild(tr);
            });
        }

        // Function to update listings
        function updateListings() {
            if (manualSearchActive) {
                return;
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch("/api/listings", { signal: controller.signal })
                .then(res => {
                    clearTimeout(timeoutId);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || !Array.isArray(data.listings)) {
                        throw new Error('Invalid listings data');
                    }

                    renderListingsTable(data.listings, {
                        highlightNew: true,
                        emptyMessage: 'No listings yet'
                    });
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        console.error("Listings update timeout");
                    } else {
                        console.error("Listings update error:", err);
                    }
                    // Don't show notification for every failed update
                });
        }

        async function searchExistingListings(options = {}) {
            if (!canSearchExistingListings) {
                showNotification('Upgrade to the Standard plan to search existing listings.', 'warning');
                return null;
            }

            const button = document.getElementById('searchExistingButton');
            if (button) {
                button.disabled = true;
            }

            try {
                const hasOverride = Object.prototype.hasOwnProperty.call(options, 'keywords');
                const overrideKeywords = hasOverride ? options.keywords : document.querySelector('input[name="keywords"]').value;
                const keywords = (overrideKeywords || '').trim();

                if (!keywords) {
                    showNotification('Enter keywords before searching existing listings.', 'warning');
                    return null;
                }

                const params = new URLSearchParams();
                params.set('keywords', keywords);
                if (options.limit) {
                    params.set('limit', options.limit);
                }

                const response = await fetch(`/api/listings/search?${params.toString()}`);
                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    const message = data && data.error ? data.error : 'Failed to search listings';
                    throw new Error(message);
                }

                renderListingsTable(data.listings || [], {
                    highlightNew: false,
                    emptyMessage: 'No existing listings matched your keywords.'
                });

                manualSearchActive = true;
                if (manualSearchResetTimer) {
                    clearTimeout(manualSearchResetTimer);
                }
                manualSearchResetTimer = setTimeout(() => {
                    manualSearchActive = false;
                    manualSearchResetTimer = null;
                    updateListings();
                }, manualSearchResetMs);

                if (!options.suppressSuccess) {
                    const total = typeof data.count === 'number'
                        ? data.count
                        : (Array.isArray(data.listings) ? data.listings.length : 0);
                    showNotification(
                        `Found ${total} existing listing${total === 1 ? '' : 's'}. Auto-refresh paused for ${manualSearchResetMs / 1000}s.`,
                        'success'
                    );
                }

                return data;
            } catch (error) {
                console.error('Error searching listings:', error);
                showNotification(error.message || 'Failed to search existing listings', 'error');
                if (!manualSearchResetTimer) {
                    manualSearchActive = false;
                }
                return null;
            } finally {
                if (button) {
                    button.disabled = false;
                }
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        const FEED_TYPE_META = {
            listing_alert: { icon: 'fa-tags', label: 'Listing Alert' },
            server_announcement: { icon: 'fa-bullhorn', label: 'Server Announcement' },
            server_hot_thread: { icon: 'fa-fire', label: 'Hot Thread' },
            server_marketplace_drop: { icon: 'fa-store', label: 'Marketplace Drop' },
            home_server_highlight: { icon: 'fa-star', label: 'Server Highlight' },
            server_created: { icon: 'fa-sun', label: 'New Server' },
            server_launched: { icon: 'fa-sun', label: 'Server Launch' },
            server_member_joined: { icon: 'fa-user-plus', label: 'New Member' },
            dm_message: { icon: 'fa-envelope-open-text', label: 'Direct Message' },
        };

        const NOTIFICATION_TYPE_META = {
            dm_message: { icon: 'fa-envelope', label: 'Direct Message' },
            server_member_joined: { icon: 'fa-user-plus', label: 'Server Member Joined' },
        };

        function formatTimestamp(value) {
            if (!value) {
                return '';
            }
            if (value instanceof Date) {
                return value.toLocaleString();
            }
            const normalized = typeof value === 'string' ? value.replace(' ', 'T') : value;
            const date = new Date(normalized);
            if (Number.isNaN(date.getTime())) {
                return String(value);
            }
            return date.toLocaleString();
        }

        function renderFeedItem(event) {
            if (!event || typeof event !== 'object') {
                return '';
            }
            const meta = FEED_TYPE_META[event.event_type] || {
                icon: 'fa-bolt',
                label: (event.event_type || 'Update').replace(/_/g, ' '),
            };
            const createdAt = escapeHtml(formatTimestamp(event.created_at));
            const payload = event.payload || {};
            let content = '';

            switch (event.event_type) {
                case 'listing_alert': {
                    const priceRaw = payload.price;
                    let priceDisplay = 'New listing';
                    if (priceRaw !== undefined && priceRaw !== null && priceRaw !== '') {
                        const priceNumber = Number(priceRaw);
                        priceDisplay = Number.isFinite(priceNumber)
                            ? `$${priceNumber.toLocaleString()}`
                            : String(priceRaw);
                    }
                    content = `
                        <strong>${escapeHtml(payload.title || 'New listing')}</strong>
                        <div class="feed-meta">
                            <span>${escapeHtml(priceDisplay)}</span>
                            ${payload.source ? `<span>${escapeHtml(String(payload.source).toUpperCase())}</span>` : ''}
                        </div>
                        ${payload.link ? `<a href="${escapeHtml(payload.link)}" target="_blank" rel="noopener noreferrer">View listing</a>` : ''}
                    `;
                    break;
                }
                case 'server_member_joined': {
                    const serverName = payload.server ? (payload.server.name || payload.server.slug || '') : '';
                    const memberName = payload.member ? (payload.member.display_name || payload.member.username || '') : '';
                    content = `
                        <strong>${escapeHtml(memberName || 'New member')}</strong>
                        ${serverName ? `<div class="feed-meta"><span>${escapeHtml(serverName)}</span></div>` : ''}
                    `;
                    break;
                }
                case 'dm_message': {
                    const senderName = payload.sender_display || payload.sender || event.actor_username || 'Direct message';
                    const preview = payload.preview || '';
                    content = `
                        <strong>${escapeHtml(senderName)}</strong>
                        ${preview ? `<p>${escapeHtml(preview)}</p>` : ''}
                    `;
                    break;
                }
                default: {
                    const serverName = payload.server ? (payload.server.name || payload.server.slug || '') : '';
                    const channelName = payload.channel ? (payload.channel.name || payload.channel.slug || '') : '';
                    const messageSnippet = payload.message ? (payload.message.snippet || payload.message.preview || '') : '';
                    const metaBits = [];
                    if (channelName) {
                        metaBits.push(`<span>${escapeHtml(channelName)}</span>`);
                    }
                    if (payload.message && payload.message.type && payload.message.type !== 'text') {
                        metaBits.push(`<span>${escapeHtml(String(payload.message.type).replace(/_/g, ' '))}</span>`);
                    }
                    content = `
                        ${serverName ? `<strong>${escapeHtml(serverName)}</strong>` : ''}
                        ${messageSnippet ? `<p>${escapeHtml(messageSnippet)}</p>` : ''}
                        ${metaBits.length ? `<div class="feed-meta">${metaBits.join('')}</div>` : ''}
                    `;
                    break;
                }
            }

            const actorLine = event.actor_username
                ? `<div class="feed-meta">by ${escapeHtml(event.actor_username)}</div>`
                : '';

            return `
                <div class="feed-item">
                    <div class="feed-item-icon"><i class="fas ${meta.icon}"></i></div>
                    <div class="feed-item-body">
                        <div class="feed-item-top">
                            <span class="feed-label">${escapeHtml(meta.label)}</span>
                            <span class="feed-time">${createdAt}</span>
                        </div>
                        <div class="feed-item-content">
                            ${content}
                        </div>
                        ${actorLine}
                    </div>
                </div>
            `;
        }

        function renderHomeFeed(events) {
            const container = document.getElementById('activity-feed-list');
            if (!container) {
                return;
            }
            if (!events || !events.length) {
                container.innerHTML = '<p class="feed-empty">No recent activity yet.</p>';
                return;
            }
            container.innerHTML = events.map(renderFeedItem).join('');
        }

        async function loadHomeFeed() {
            const container = document.getElementById('activity-feed-list');
            if (!container) {
                return;
            }
            container.innerHTML = '<p class="feed-empty">Loading activity feed…</p>';
            try {
                const response = await fetch('/api/feed/home?limit=25');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderHomeFeed(data.events || []);
            } catch (error) {
                console.error('Home feed error:', error);
                container.innerHTML = '<p class="feed-empty">Unable to load activity feed.</p>';
            }
        }

        function renderServerFeed(events) {
            const container = document.getElementById('server-feed-list');
            if (!container) {
                return;
            }
            if (!events || !events.length) {
                container.innerHTML = '<p class="feed-empty">No highlights yet.</p>';
                return;
            }
            container.innerHTML = events.map(renderFeedItem).join('');
        }

        async function loadServerOptions() {
            const selector = document.getElementById('server-feed-selector');
            if (!selector) {
                return;
            }
            selector.innerHTML = '<option value="">Loading servers…</option>';
            try {
                const response = await fetch('/api/servers?status=active&limit=100');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                const servers = Array.isArray(data.servers) ? data.servers : [];
                feedState.servers = servers;

                if (!servers.length) {
                    feedState.selectedServer = null;
                    selector.innerHTML = '<option value="">Join a server to unlock highlights</option>';
                    const container = document.getElementById('server-feed-list');
                    if (container) {
                        container.innerHTML = '<p class="feed-empty">Join a server to see highlights here.</p>';
                    }
                    return;
                }

                selector.innerHTML = '<option value="">Select a server</option>' + servers.map(server => {
                    const slugValue = server.slug || (server.id ? String(server.id) : '');
                    const labelValue = server.name || server.slug || `Server ${server.id || ''}`;
                    return `<option value="${escapeHtml(slugValue)}">${escapeHtml(labelValue)}</option>`;
                }).join('');

                const firstServer = servers[0];
                if (firstServer) {
                    const slugValue = firstServer.slug || (firstServer.id ? String(firstServer.id) : '');
                    feedState.selectedServer = slugValue;
                    selector.value = slugValue;
                    await loadServerFeed(slugValue);
                }
            } catch (error) {
                console.error('Server list error:', error);
                selector.innerHTML = '<option value="">Unable to load servers</option>';
            }
        }

        async function loadServerFeed(slug) {
            const container = document.getElementById('server-feed-list');
            if (!container) {
                return;
            }
            if (!slug) {
                container.innerHTML = '<p class="feed-empty">Select a server to see highlights.</p>';
                return;
            }

            container.innerHTML = '<p class="feed-empty">Loading server highlights…</p>';
            try {
                const response = await fetch(`/api/feed/servers/${encodeURIComponent(slug)}?limit=25`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderServerFeed(data.events || []);
            } catch (error) {
                console.error('Server feed error:', error);
                container.innerHTML = '<p class="feed-empty">Unable to load server highlights.</p>';
            }
        }

        function renderNotifications(data) {
            const todayContainer = document.getElementById('notifications-today');
            const earlierContainer = document.getElementById('notifications-earlier');
            if (!todayContainer || !earlierContainer) {
                return;
            }

            const grouped = data && data.grouped ? data.grouped : { today: [], earlier: [] };
            const todayList = Array.isArray(grouped.today) ? grouped.today : [];
            const earlierList = Array.isArray(grouped.earlier) ? grouped.earlier : [];

            if (!todayList.length) {
                todayContainer.innerHTML = '<p class="feed-empty">No notifications yet.</p>';
            } else {
                todayContainer.innerHTML = todayList.map(renderNotificationItem).join('');
            }

            if (!earlierList.length) {
                earlierContainer.innerHTML = '<p class="feed-empty">You\'re all caught up.</p>';
            } else {
                earlierContainer.innerHTML = earlierList.map(renderNotificationItem).join('');
            }

            const countElement = document.getElementById('notifications-count');
            if (countElement) {
                const unreadCount = data && typeof data.unread_total === 'number' ? data.unread_total : 0;
                countElement.textContent = unreadCount;
            }
        }

        async function loadNotifications() {
            const todayContainer = document.getElementById('notifications-today');
            if (todayContainer) {
                todayContainer.innerHTML = '<p class="feed-empty">Loading notifications…</p>';
            }
            const earlierContainer = document.getElementById('notifications-earlier');
            if (earlierContainer) {
                earlierContainer.innerHTML = '';
            }
            try {
                const response = await fetch('/api/notifications?limit=50');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderNotifications(data);
            } catch (error) {
                console.error('Notifications error:', error);
                if (todayContainer) {
                    todayContainer.innerHTML = '<p class="feed-empty">Unable to load notifications.</p>';
                }
            }
        }

        function renderNotificationItem(notification) {
            if (!notification || typeof notification !== 'object') {
                return '';
            }
            const meta = NOTIFICATION_TYPE_META[notification.notification_type] || {
                icon: 'fa-bell',
                label: (notification.notification_type || 'Notification').replace(/_/g, ' '),
            };
            const payload = notification.payload || {};
            let content = '';

            if (notification.notification_type === 'dm_message') {
                const senderName = payload.sender_display || payload.sender || 'Direct message';
                const preview = payload.preview || '';
                content = `
                    <strong>${escapeHtml(senderName)}</strong>
                    ${preview ? `<p>${escapeHtml(preview)}</p>` : ''}
                `;
            } else if (notification.notification_type === 'server_member_joined') {
                const serverName = payload.server ? (payload.server.name || payload.server.slug || '') : '';
                const memberName = payload.member ? (payload.member.display_name || payload.member.username || '') : '';
                content = `
                    <strong>${escapeHtml(memberName || 'New member')}</strong>
                    ${serverName ? `<div class="feed-meta"><span>${escapeHtml(serverName)}</span></div>` : ''}
                `;
            } else {
                content = `<p>${escapeHtml('You have a new notification.')}</p>`;
            }

            const unreadClass = notification.read_at ? '' : ' unread';
            const createdAt = escapeHtml(formatTimestamp(notification.created_at));
            const notificationId = escapeHtml(String(notification.id));
            const actions = [];
            if (!notification.read_at) {
                actions.push('<button data-action="read">Mark Read</button>');
            }
            actions.push('<button data-action="dismiss">Dismiss</button>');

            return `
                <div class="notification-item${unreadClass}" data-id="${notificationId}">
                    <div class="notification-icon"><i class="fas ${meta.icon}"></i></div>
                    <div class="notification-body">
                        <div class="notification-header">
                            <span class="notification-label">${escapeHtml(meta.label)}</span>
                            <span class="notification-time">${createdAt}</span>
                        </div>
                        <div class="notification-content">
                            ${content}
                        </div>
                        <div class="notification-actions">
                            ${actions.join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function markNotificationRead(id) {
            if (!id) {
                return;
            }
            try {
                await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: [Number(id)] }),
                });
                await loadNotifications();
            } catch (error) {
                console.error('Failed to mark notification read:', error);
            }
        }

        async function dismissNotification(id) {
            if (!id) {
                return;
            }
            try {
                await fetch('/api/notifications/dismiss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: Number(id) }),
                });
                await loadNotifications();
            } catch (error) {
                console.error('Failed to dismiss notification:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ all: true }),
                });
                await loadNotifications();
            } catch (error) {
                console.error('Failed to mark all notifications read:', error);
            }
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Favorite functionality
        async function toggleFavorite(listingId, title, price, link, imageUrl, source) {
            const button = event.target.closest('.favorite-btn');
            
            // If called from data attributes, read them
            if (!listingId && button) {
                listingId = button.dataset.id;
                title = button.dataset.title;
                price = button.dataset.price;
                link = button.dataset.link;
                imageUrl = button.dataset.image;
                source = button.dataset.source;
            }
            
            const isFavorited = button.classList.contains('favorited');

            try {
                if (isFavorited) {
                    // Remove from favorites
                    const response = await fetch(`/api/favorites/${listingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        button.classList.remove('favorited');
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        showNotification('Removed from favorites', 'info');
                    } else {
                        throw new Error('Failed to remove favorite');
                    }
                } else {
                    // Add to favorites
                    const response = await fetch(`/api/favorites/${listingId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            notes: ''
                        })
                    });

                    if (response.ok) {
                        button.classList.add('favorited');
                        button.querySelector('i').classList.remove('far');
                        button.querySelector('i').classList.add('fas');
                        showNotification('Added to favorites!', 'success');
                    } else {
                        throw new Error('Failed to add favorite');
                    }
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                showNotification('Error updating favorite', 'error');
            }
        }

        // Load saved searches
        async function loadSavedSearches() {
            try {
                const response = await fetch('/api/saved-searches');
                const data = await response.json();
                
                const container = document.getElementById('savedSearchesList');
                if (!container) return;

                if (data.searches && data.searches.length > 0) {
                    container.innerHTML = data.searches.map(search => `
                        <div class="saved-search-item">
                            <div class="search-info">
                                <strong>${escapeHtml(search.name)}</strong><br>
                                <small>
                                    ${search.keywords ? `Keywords: ${escapeHtml(search.keywords)}` : ''} 
                                    ${search.min_price ? `| Min: $${search.min_price}` : ''} 
                                    ${search.max_price ? `| Max: $${search.max_price}` : ''}
                                </small>
                            </div>
                            <div class="search-actions">
                                <button onclick="runSavedSearch(${search.id})" title="Run this search">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="delete" onclick="deleteSavedSearch(${search.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">No saved searches yet</p>';
                }
            } catch (error) {
                console.error('Error loading saved searches:', error);
            }
        }

        // Create saved search from current settings
        async function saveCurrentSearch() {
            const name = prompt('Enter a name for this search:');
            if (!name) return;

            const keywords = document.querySelector('input[name="keywords"]').value;
            const minPrice = document.querySelector('input[name="min_price"]').value;
            const maxPrice = document.querySelector('input[name="max_price"]').value;
            const location = document.querySelector('input[name="location"]').value;
            const radius = document.querySelector('input[name="radius"]').value;

            try {
                const response = await fetch('/api/saved-searches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        keywords: keywords,
                        min_price: minPrice ? parseInt(minPrice) : null,
                        max_price: maxPrice ? parseInt(maxPrice) : null,
                        location: location,
                        radius: radius ? parseInt(radius) : null,
                        notify_new: true
                    })
                });

                if (response.ok) {
                    showNotification('Search saved successfully!', 'success');
                    loadSavedSearches();
                } else {
                    throw new Error('Failed to save search');
                }
            } catch (error) {
                console.error('Error saving search:', error);
                showNotification('Failed to save search', 'error');
            }
        }

        // Delete a saved search
        async function deleteSavedSearch(searchId) {
            if (!confirm('Delete this saved search?')) return;

            try {
                const response = await fetch(`/api/saved-searches/${searchId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Search deleted', 'info');
                    loadSavedSearches();
                } else {
                    throw new Error('Failed to delete search');
                }
            } catch (error) {
                console.error('Error deleting search:', error);
                showNotification('Failed to delete search', 'error');
            }
        }

        // Run a saved search (load its settings)
        async function runSavedSearch(searchId) {
            try {
                const response = await fetch('/api/saved-searches');
                const data = await response.json();
                const search = data.searches.find(s => s.id === searchId);
                
                if (search) {
                    if (search.keywords) document.querySelector('input[name="keywords"]').value = search.keywords;
                    if (search.min_price) document.querySelector('input[name="min_price"]').value = search.min_price;
                    if (search.max_price) document.querySelector('input[name="max_price"]').value = search.max_price;
                    if (search.location) document.querySelector('input[name="location"]').value = search.location;
                    if (search.radius) document.querySelector('input[name="radius"]').value = search.radius;

                    const activeKeywords = document.querySelector('input[name="keywords"]').value;
                    let searchResult = null;
                    if (canSearchExistingListings && activeKeywords) {
                        searchResult = await searchExistingListings({
                            keywords: activeKeywords,
                            suppressSuccess: true
                        });
                    }

                    let matchSuffix = '';
                    if (searchResult) {
                        const matchCount = typeof searchResult.count === 'number'
                            ? searchResult.count
                            : (Array.isArray(searchResult.listings) ? searchResult.listings.length : null);
                        if (matchCount !== null) {
                            matchSuffix = ` (${matchCount} match${matchCount === 1 ? '' : 'es'})`;
                        }
                    }

                    const pauseInfo = searchResult ? ` Auto-refresh paused ${manualSearchResetMs / 1000}s.` : '';
                    showNotification(`Loaded search: ${search.name}${matchSuffix}${pauseInfo}`, 'success');
                }
            } catch (error) {
                console.error('Error running saved search:', error);
                showNotification('Failed to load search', 'error');
            }
        }

        // Function to start polling
        function startPolling() {
            // Clear existing intervals to prevent memory leaks
            stopPolling();
            
            statusInterval = setInterval(updateStatus, 3000); // update bot status every 3s
            listingsInterval = setInterval(updateListings, 5000); // update listings every 5s
        }

        // Function to stop polling
        function stopPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            if (listingsInterval) {
                clearInterval(listingsInterval);
                listingsInterval = null;
            }
            if (manualSearchResetTimer) {
                clearTimeout(manualSearchResetTimer);
                manualSearchResetTimer = null;
            }
            manualSearchActive = false;
        }

        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startPolling();
            loadSavedSearches();
            loadHomeFeed();
            loadServerOptions();
            loadNotifications();

            const refreshHomeBtn = document.getElementById('refresh-home-feed');
            if (refreshHomeBtn) {
                refreshHomeBtn.addEventListener('click', async function() {
                    refreshHomeBtn.disabled = true;
                    try {
                        await loadHomeFeed();
                    } finally {
                        refreshHomeBtn.disabled = false;
                    }
                });
            }

            const refreshServerBtn = document.getElementById('refresh-server-feed');
            if (refreshServerBtn) {
                refreshServerBtn.addEventListener('click', async function() {
                    if (!feedState.selectedServer) {
                        await loadServerOptions();
                        return;
                    }
                    refreshServerBtn.disabled = true;
                    try {
                        await loadServerFeed(feedState.selectedServer);
                    } finally {
                        refreshServerBtn.disabled = false;
                    }
                });
            }

            const serverSelector = document.getElementById('server-feed-selector');
            if (serverSelector) {
                serverSelector.addEventListener('change', function(event) {
                    const selected = event.target.value;
                    feedState.selectedServer = selected;
                    loadServerFeed(selected);
                });
            }

            const refreshNotificationsBtn = document.getElementById('notifications-refresh');
            if (refreshNotificationsBtn) {
                refreshNotificationsBtn.addEventListener('click', async function() {
                    refreshNotificationsBtn.disabled = true;
                    try {
                        await loadNotifications();
                    } finally {
                        refreshNotificationsBtn.disabled = false;
                    }
                });
            }

            const markAllBtn = document.getElementById('notifications-mark-all');
            if (markAllBtn) {
                markAllBtn.addEventListener('click', async function() {
                    markAllBtn.disabled = true;
                    try {
                        await markAllNotificationsRead();
                    } finally {
                        markAllBtn.disabled = false;
                    }
                });
            }

            document.addEventListener('click', function(e) {
                const favoriteButton = e.target.closest('.favorite-btn');
                if (favoriteButton) {
                    e.preventDefault();
                    toggleFavorite();
                    return;
                }
                const notificationButton = e.target.closest('.notification-actions button');
                if (notificationButton) {
                    e.preventDefault();
                    const action = notificationButton.dataset.action;
                    const notificationItem = notificationButton.closest('.notification-item');
                    if (!notificationItem) {
                        return;
                    }
                    const notificationId = notificationItem.getAttribute('data-id');
                    if (action === 'read') {
                        markNotificationRead(notificationId);
                    } else if (action === 'dismiss') {
                        dismissNotification(notificationId);
                    }
                }
            });
        });

        // Stop polling when page is about to unload (prevents memory leaks)
        window.addEventListener('beforeunload', function() {
            stopPolling();
        });

        // Handle page visibility changes to pause/resume polling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopPolling();
            } else {
                startPolling();
            }
        });
    </script>
</body>
</html>
